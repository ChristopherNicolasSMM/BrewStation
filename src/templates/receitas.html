{% extends 'base.html' %}
{% block title %}Receitas - BrewFather{% endblock %}

{% block content %}
<div class="pagetitle">
  <h1>Receitas - BrewFather</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Home</a></li>
      <li class="breadcrumb-item active">Receitas</li>
    </ol>
  </nav>
  <div id="alert-area"></div>
</div>

<section class="section">
  <div class="row">
    <div class="col-lg-12">
      
      <!-- Card de Seleção de Receita do BrewFather -->
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title">Selecionar Receita do BrewFather</h5>
            <div>
              <button class="btn btn-outline-primary btn-sm" id="btn-sync-receitas">
                <i class="bi bi-arrow-clockwise"></i> Sincronizar Receitas
              </button>
              <button class="btn btn-outline-secondary btn-sm" id="btn-refresh-receitas">
                <i class="bi bi-arrow-repeat"></i> Atualizar Lista
              </button>
            </div>
          </div>

          <div class="row g-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label">Receita</label>
              <select class="form-select" id="brewfather-recipe-select">
                <option value="">Selecione uma receita...</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Buscar</label>
              <input type="text" class="form-control" id="search-recipe" placeholder="Nome da receita...">
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary w-100" id="btn-carregar-receita">
                <i class="bi bi-cloud-download"></i> Carregar
              </button>
            </div>
          </div>

          <!-- Informações da Receita Selecionada -->
          <div id="recipe-info" class="mt-4" style="display: none;">
            <div class="row">
              <div class="col-md-3">
                <strong>Estilo:</strong> <span id="info-estilo">-</span>
              </div>
              <div class="col-md-2">
                <strong>ABV:</strong> <span id="info-abv">-</span>%
              </div>
              <div class="col-md-2">
                <strong>IBU:</strong> <span id="info-ibu">-</span>
              </div>
              <div class="col-md-2">
                <strong>Cor:</strong> <span id="info-cor">-</span> EBC
              </div>
              <div class="col-md-3">
                <strong>Volume:</strong> <span id="info-volume">-</span> L
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-md-3">
                <strong>OG:</strong> <span id="info-og">-</span>
              </div>
              <div class="col-md-3">
                <strong>FG:</strong> <span id="info-fg">-</span>
              </div>
              <div class="col-md-3">
                <strong>Eficiência:</strong> <span id="info-eficiencia">-</span>%
              </div>
              <div class="col-md-3">
                <strong>Avaliação:</strong> <span id="info-avaliacao">-</span>/5
              </div>
            </div>
            <div class="row mt-2" id="recipe-notes" style="display: none;">
              <div class="col-12">
                <strong>Notas:</strong> <span id="info-notas">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card de Ingredientes -->
      <div class="card mt-4">
        <div class="card-body">
          <h5 class="card-title">Ingredientes da Receita</h5>
          
          <div class="alert alert-info" id="no-recipe-alert">
            <i class="bi bi-info-circle"></i> Selecione uma receita do BrewFather para visualizar os ingredientes.
          </div>

          <div id="ingredients-section" style="display: none;">
            <!-- Abas para diferentes tipos de ingredientes -->
            <ul class="nav nav-tabs" id="ingredientsTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="maltes-tab" data-bs-toggle="tab" data-bs-target="#maltes" type="button" role="tab">
                  Maltes & Grãos
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="lupulos-tab" data-bs-toggle="tab" data-bs-target="#lupulos" type="button" role="tab">
                  Lúpulos
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="leveduras-tab" data-bs-toggle="tab" data-bs-target="#leveduras" type="button" role="tab">
                  Leveduras
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="outros-tab" data-bs-toggle="tab" data-bs-target="#outros" type="button" role="tab">
                  Outros
                </button>
              </li>
            </ul>

            <div class="tab-content mt-3" id="ingredientsTabContent">
              <!-- Tab Maltes -->
              <div class="tab-pane fade show active" id="maltes" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Malte</th>
                        <th>Fabricante</th>
                        <th>Quantidade (kg)</th>
                        <th>Rendimento (%)</th>
                        <th>Cor (EBC)</th>
                        <th>Custo (R$)</th>
                      </tr>
                    </thead>
                    <tbody id="maltes-table-body">
                    </tbody>
                    <tfoot>
                      <tr>
                        <th colspan="5" class="text-end">Total Maltes:</th>
                        <th id="total-custo-maltes">R$ 0,00</th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <!-- Tab Lúpulos -->
              <div class="tab-pane fade" id="lupulos" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Lúpulo</th>
                        <th>Fabricante</th>
                        <th>Quantidade (g)</th>
                        <th>Alpha Ácidos (%)</th>
                        <th>Uso</th>
                        <th>Tempo (min)</th>
                        <th>Custo (R$)</th>
                      </tr>
                    </thead>
                    <tbody id="lupulos-table-body">
                    </tbody>
                    <tfoot>
                      <tr>
                        <th colspan="6" class="text-end">Total Lúpulos:</th>
                        <th id="total-custo-lupulos">R$ 0,00</th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <!-- Tab Leveduras -->
              <div class="tab-pane fade" id="leveduras" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Levedura</th>
                        <th>Fabricante</th>
                        <th>Quantidade</th>
                        <th>Atenuação (%)</th>
                        <th>Formato</th>
                        <th>Custo (R$)</th>
                      </tr>
                    </thead>
                    <tbody id="leveduras-table-body">
                    </tbody>
                    <tfoot>
                      <tr>
                        <th colspan="5" class="text-end">Total Leveduras:</th>
                        <th id="total-custo-leveduras">R$ 0,00</th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <!-- Tab Outros -->
              <div class="tab-pane fade" id="outros" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Ingrediente</th>
                        <th>Tipo</th>
                        <th>Quantidade</th>
                        <th>Unidade</th>
                        <th>Uso</th>
                        <th>Custo (R$)</th>
                      </tr>
                    </thead>
                    <tbody id="outros-table-body">
                    </tbody>
                    <tfoot>
                      <tr>
                        <th colspan="5" class="text-end">Total Outros:</th>
                        <th id="total-custo-outros">R$ 0,00</th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <div class="alert alert-secondary">
                  <strong>Custo Total Ingredientes:</strong> <span id="custo-total-ingredientes">R$ 0,00</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="alert alert-info">
                  <strong>Custo por Litro:</strong> <span id="custo-por-litro">R$ 0,00</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card de Cálculo de Preço -->
      <div class="card mt-4">
        <div class="card-body">
          <h5 class="card-title">Cálculo de Preço</h5>

          <form id="form-calculo" class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Tipo de Envase</label>
              <select class="form-select" id="tipo-embalagem">
                <option value="litro" data-ml="1000">Litro (1000 ml)</option>
                <option value="garrafa-500" data-ml="500" selected>Garrafa 500 ml</option>
                <option value="garrafa-600" data-ml="600">Garrafa 600 ml</option>
                <option value="garrafa-330" data-ml="330">Garrafa 330 ml</option>
                <option value="keg-30l" data-ml="30000">Keg 30 L</option>
                <option value="keg-50l" data-ml="50000">Keg 50 L</option>
                <option value="barril-20l" data-ml="20000">Barril 20 L</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Quantidade (ml)</label>
              <input type="number" min="50" step="10" class="form-control" id="quantidade-ml" value="500">
            </div>
            <div class="col-md-2">
              <label class="form-label">Custo Embalagem</label>
              <input type="number" min="0" step="0.01" class="form-control" id="custo-embalagem" value="1.50">
            </div>
            <div class="col-md-2">
              <label class="form-label">Custo Impressão</label>
              <input type="number" min="0" step="0.01" class="form-control" id="custo-impressao" value="0.50">
            </div>
            <div class="col-md-2">
              <label class="form-label">Custo Tampinha</label>
              <input type="number" min="0" step="0.01" class="form-control" id="custo-tampinha" value="0.30">
            </div>
            <div class="col-md-3">
              <label class="form-label">% Lucro</label>
              <input type="number" min="0" step="0.1" class="form-control" id="percentual-lucro" value="30">
            </div>
            <div class="col-md-3">
              <label class="form-label">% Margem Cartão</label>
              <input type="number" min="0" step="0.1" class="form-control" id="margem-cartao" value="2.5">
            </div>
            <div class="col-md-3">
              <label class="form-label">% Sanitização</label>
              <input type="number" min="0" step="0.1" class="form-control" id="percentual-sanitizacao" value="1.5">
            </div>
            <div class="col-md-3">
              <label class="form-label">% Impostos</label>
              <input type="number" min="0" step="0.1" class="form-control" id="percentual-impostos" value="15">
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button class="btn btn-primary" id="btn-calcular" type="submit" disabled>
                <i class="bi bi-calculator"></i> Calcular Preço
              </button>
            </div>
          </form>

          <!-- Resultados do Cálculo -->
          <div id="resultados-calculo" class="mt-4" style="display: none;">
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6 class="card-title mb-0">Detalhes do Custo</h6>
                  </div>
                  <div class="card-body">
                    <table class="table table-sm">
                      <tr>
                        <td>Custo Ingredientes:</td>
                        <td id="detalhe-custo-ingredientes" class="text-end">R$ 0,00</td>
                      </tr>
                      <tr>
                        <td>Custo Embalagem:</td>
                        <td id="detalhe-custo-embalagem" class="text-end">R$ 0,00</td>
                      </tr>
                      <tr>
                        <td>Custo Impressão:</td>
                        <td id="detalhe-custo-impressao" class="text-end">R$ 0,00</td>
                      </tr>
                      <tr>
                        <td>Custo Tampinha:</td>
                        <td id="detalhe-custo-tampinha" class="text-end">R$ 0,00</td>
                      </tr>
                      <tr>
                        <td><strong>Subtotal:</strong></td>
                        <td id="detalhe-subtotal" class="text-end"><strong>R$ 0,00</strong></td>
                      </tr>
                      <tr>
                        <td>Sanitização (+<span id="percent-sanitizacao">0</span>%):</td>
                        <td id="detalhe-sanitizacao" class="text-end">R$ 0,00</td>
                      </tr>
                      <tr>
                        <td>Lucro (+<span id="percent-lucro">0</span>%):</td>
                        <td id="detalhe-lucro" class="text-end">R$ 0,00</td>
                      </tr>
                      <tr>
                        <td>Impostos (+<span id="percent-impostos">0</span>%):</td>
                        <td id="detalhe-impostos" class="text-end">R$ 0,00</td>
                      </tr>
                      <tr>
                        <td>Margem Cartão (+<span id="percent-cartao">0</span>%):</td>
                        <td id="detalhe-cartao" class="text-end">R$ 0,00</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-success text-white">
                  <div class="card-header">
                    <h6 class="card-title mb-0">Preço Final de Venda</h6>
                  </div>
                  <div class="card-body text-center">
                    <h2 id="valor-venda-final">R$ 0,00</h2>
                    <p class="mb-0">por <span id="unidade-venda">unidade</span></p>
                    <small id="preco-por-litro">(R$ 0,00 por litro)</small>
                  </div>
                </div>
                
                <div class="card mt-3">
                  <div class="card-header">
                    <h6 class="card-title mb-0">Resumo</h6>
                  </div>
                  <div class="card-body">
                    <div><strong>Preço por litro base:</strong> <span id="valor-litro-base">R$ 0,00</span></div>
                    <div><strong>Margem de lucro:</strong> <span id="margem-lucro-real">0%</span></div>
                    <div><strong>Volume da receita:</strong> <span id="volume-receita">0</span> L</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/receitas-brewfather.js') }}"></script>
{% endblock %}