<!-- templates/brewfather.html -->
{% extends "base.html" %}

{% block title %}BrewFather - BrewStation{% endblock %}

{% block content %}
<div class="pagetitle">
    <h1>BrewFather</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
            <li class="breadcrumb-item active">BrewFather</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section brewfather">
    <div class="row">
        <div class="col-lg-12">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Integra√ß√£o BrewFather</h5>

                            <!-- Status da Integra√ß√£o -->
                            <div class="row mb-4">
                                <div class="col-xl-3 col-md-6">
                                    <div class="card info-card sales-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Status</h5>
                                            <div class="d-flex align-items-center">
                                                <div
                                                    class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-cloud-check" id="status-icon"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6 id="status-text">Verificando...</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6">
                                    <div class="card info-card revenue-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Receitas</h5>
                                            <div class="d-flex align-items-center">
                                                <div
                                                    class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-journal-text"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6 id="recipes-count">0</h6>
                                                    <span class="text-muted small">sincronizadas</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6">
                                    <div class="card info-card customers-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Lotes</h5>
                                            <div class="d-flex align-items-center">
                                                <div
                                                    class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-clipboard-data"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6 id="batches-count">0</h6>
                                                    <span class="text-muted small">sincronizados</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6">
                                    <div class="card info-card customers-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Estoque</h5>
                                            <div class="d-flex align-items-center">
                                                <div
                                                    class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-box-seam"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6 id="inventory-count">0</h6>
                                                    <span class="text-muted small">itens</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Barra de Ferramentas -->
                            <div class="toolbar mb-3">
                                <button class="btn btn-primary" onclick="syncAll()">
                                    <i class="bi bi-arrow-repeat"></i> Sincronizar Tudo
                                </button>
                                <button class="btn btn-success" onclick="syncRecipes()">
                                    <i class="bi bi-journal-text"></i> Sincronizar Receitas
                                </button>
                                <button class="btn btn-info" onclick="syncBatches()">
                                    <i class="bi bi-clipboard-data"></i> Sincronizar Lotes
                                </button>
                                <button class="btn btn-warning" onclick="syncInventory()">
                                    <i class="bi bi-box-seam"></i> Sincronizar Estoque
                                </button>
                                <button class="btn btn-outline-secondary" onclick="loadStatus()">
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                                </button>
                                <button class="btn btn-outline-primary" onclick="fetchRecipesFromBrewFather()"
                                    id="fetch-recipes-btn">
                                    <i class="bi bi-cloud-download"></i> Buscar Receitas da API
                                </button>
                            </div>

                            <!-- Alertas -->
                            <div id="alert-container"></div>

                            <!-- Abas -->
                            <ul class="nav nav-tabs nav-tabs-bordered" id="brewfatherTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="recipes-tab" data-bs-toggle="tab"
                                        data-bs-target="#recipes" type="button" role="tab">
                                        <i class="bi bi-journal-text me-2"></i>Receitas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="batches-tab" data-bs-toggle="tab"
                                        data-bs-target="#batches" type="button" role="tab">
                                        <i class="bi bi-clipboard-data me-2"></i>Lotes
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="inventory-tab" data-bs-toggle="tab"
                                        data-bs-target="#inventory" type="button" role="tab">
                                        <i class="bi bi-box-seam me-2"></i>Estoque
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync"
                                        type="button" role="tab">
                                        <i class="bi bi-arrow-repeat me-2"></i>Sincroniza√ß√£o
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content pt-3" id="brewfatherTabsContent">
                                <!-- Tab Receitas -->
                                <div class="tab-pane fade show active" id="recipes" role="tabpanel">












                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Lista de Receitas Sincronizadas</h6>
                                        <div>


                                            <!-- Adicione este bot√£o junto com os outros bot√µes na toolbar -->
                                            <button class="btn btn-outline-info"
                                                onclick="cadastrarTodosInsumosReceita()"
                                                id="cadastrar-todos-insumos-btn">
                                                <i class="bi bi-boxes"></i> Cadastrar Todos os Insumos
                                            </button>


                                            <button class="btn btn-info btn-sm" onclick="cadastrarInsumosReceita()">
                                                <i class="bi bi-box-seam"></i> Cadastrar Insumos
                                            </button>

                                            <button class="btn btn-warning btn-sm" onclick="verIngredientesFaltantes()">
                                                <i class="bi bi-search"></i> Ver Faltantes
                                            </button>







                                            <button class="btn btn-sm btn-outline-success"
                                                onclick="calculateSelectedRecipeCost()" id="calculate-cost-btn"
                                                disabled>
                                                <i class="bi bi-calculator"></i> Calcular Custo da Receita Selecionada
                                            </button>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="recipes-table">
                                            <thead>
                                                <tr>
                                                    <th width="30"></th>
                                                    <th>Nome</th>
                                                    <th>Estilo</th>
                                                    <th>ABV</th>
                                                    <th>IBU</th>
                                                    <th>Cor</th>
                                                    <th>Tamanho</th>
                                                    <th>Avalia√ß√£o</th>
                                                    <th>√öltima Brassagem</th>
                                                    <th>A√ß√µes</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recipes-tbody">
                                                <!-- Dados carregados via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination justify-content-center" id="recipes-pagination">
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Tab Lotes -->
                                <div class="tab-pane fade" id="batches" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="batches-table">
                                            <thead>
                                                <tr>
                                                    <th width="30"></th>
                                                    <th>Lote</th>
                                                    <th>Receita</th>
                                                    <th>Status</th>
                                                    <th>Data</th>
                                                    <th>OG</th>
                                                    <th>FG</th>
                                                    <th>ABV</th>
                                                    <th>Avalia√ß√£o</th>
                                                    <th>A√ß√µes</th>
                                                </tr>
                                            </thead>
                                            <tbody id="batches-tbody">
                                                <!-- Dados carregados via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination justify-content-center" id="batches-pagination">
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Tab Estoque -->
                                <div class="tab-pane fade" id="inventory" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Gerenciamento de Estoque</h6>
                                        <div>
                                            <button class="btn btn-sm btn-success"
                                                onclick="showInventoryMovementModal('entrada')">
                                                <i class="bi bi-plus-circle"></i> Entrada
                                            </button>
                                            <button class="btn btn-sm btn-warning"
                                                onclick="showInventoryMovementModal('saida')">
                                                <i class="bi bi-dash-circle"></i> Sa√≠da
                                            </button>
                                            <button class="btn btn-sm btn-primary"
                                                onclick="showInventoryMovementModal('ajuste')">
                                                <i class="bi bi-arrow-clockwise"></i> Ajuste
                                            </button>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="inventory-table">
                                            <thead>
                                                <tr>
                                                    <th width="30"></th>
                                                    <th>Nome</th>
                                                    <th>Tipo</th>
                                                    <th>Categoria</th>
                                                    <th>Quantidade</th>
                                                    <th>Pre√ßo</th>
                                                    <th>Fornecedor</th>
                                                    <th>Sincronizado</th>
                                                    <th>A√ß√µes</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inventory-tbody">
                                                <!-- Dados carregados via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination justify-content-center" id="inventory-pagination">
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Tab Sincroniza√ß√£o -->
                                <div class="tab-pane fade" id="sync" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Status da Sincroniza√ß√£o</h5>
                                                    <div id="sync-status">
                                                        <!-- Status carregado via JavaScript -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Configura√ß√£o</h5>
                                                    <p>Para usar a integra√ß√£o com BrewFather, configure suas credenciais
                                                        API nas <a href="{{ url_for('main.config') }}">Configura√ß√µes do
                                                            Sistema</a>.</p>
                                                    <div class="alert alert-info">
                                                        <h6>Como obter as credenciais:</h6>
                                                        <ol class="small">
                                                            <li>Acesse seu perfil no BrewFather</li>
                                                            <li>V√° em Settings ‚Üí API</li>
                                                            <li>Copie o User ID e API Key</li>
                                                            <li>Cole nas configura√ß√µes do sistema</li>
                                                            <li>Ative a integra√ß√£o</li>
                                                        </ol>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal para Detalhes -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Detalhes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailModalBody">
                <!-- Conte√∫do carregado via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Movimenta√ß√£o de Estoque -->
<div class="modal fade" id="inventoryMovementModal" tabindex="-1" aria-labelledby="inventoryMovementModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inventoryMovementModalLabel">Movimenta√ß√£o de Estoque</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="inventoryMovementForm">
                    <input type="hidden" id="movement_type">
                    <input type="hidden" id="selected_inventory_id">

                    <div class="mb-3">
                        <label for="inventory_item" class="form-label">Item</label>
                        <input type="text" class="form-control" id="inventory_item" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="movement_quantity" class="form-label">Quantidade</label>
                        <input type="number" class="form-control" id="movement_quantity" step="0.01" min="0.01"
                            required>
                    </div>

                    <div class="mb-3">
                        <label for="movement_unit" class="form-label">Unidade</label>
                        <input type="text" class="form-control" id="movement_unit" readonly>
                    </div>

                    <div class="mb-3" id="price_field" style="display: none;">
                        <label for="movement_price" class="form-label">Pre√ßo Unit√°rio (R$)</label>
                        <input type="number" class="form-control" id="movement_price" step="0.01" min="0">
                    </div>

                    <div class="mb-3">
                        <label for="movement_notes" class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="movement_notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="processInventoryMovement()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para C√°lculo de Custo -->
<div class="modal fade" id="costCalculationModal" tabindex="-1" aria-labelledby="costCalculationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="costCalculationModalLabel">C√°lculo de Custo da Receita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="costCalculationModalBody">
                <!-- Conte√∫do carregado via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" onclick="saveRecipeCostCalculation()">Salvar
                    C√°lculo</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Vari√°veis globais
    let currentRecipesPage = 1;
    let currentBatchesPage = 1;
    let currentInventoryPage = 1;
    const perPage = 10;
    let selectedRecipeId = null;
    let selectedBatchId = null;
    let selectedInventoryId = null;

    // Carregar dados ao iniciar
    document.addEventListener('DOMContentLoaded', function () {
        loadStatus();
        loadRecipes();
        loadBatches();
        loadInventory();

        // Atualizar a cada 30 segundos
        setInterval(loadStatus, 30000);
    });

    // Fun√ß√µes de Status
    async function loadStatus() {
        try {
            const response = await fetch('/api/brewfather/status');
            const data = await response.json();

            updateStatusDisplay(data);
            updateCounts(data);

        } catch (error) {
            console.error('Erro ao carregar status:', error);
            showAlert('Erro ao carregar status do BrewFather', 'danger');
        }
    }

    async function updateCounts(status) {
        try {
            const statsResponse = await fetch('/api/brewfather/stats');
            const stats = await statsResponse.json();

            document.getElementById('recipes-count').textContent = stats.recipes_count || 0;
            document.getElementById('batches-count').textContent = stats.batches_count || 0;
            document.getElementById('inventory-count').textContent = stats.inventory_count || 0;

        } catch (error) {
            console.error('Erro ao carregar estat√≠sticas:', error);
        }
    }

    function updateStatusDisplay(status) {
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');

        if (!status.enabled) {
            statusIcon.className = 'bi bi-cloud-slash text-danger';
            statusText.textContent = 'Desativado';
            statusText.className = 'text-danger';
        } else if (!status.configured) {
            statusIcon.className = 'bi bi-cloud-exclamation text-warning';
            statusText.textContent = 'N√£o Configurado';
            statusText.className = 'text-warning';
        } else if (status.connection_test) {
            statusIcon.className = 'bi bi-cloud-check text-success';
            statusText.textContent = 'Conectado';
            statusText.className = 'text-success';
        } else {
            statusIcon.className = 'bi bi-cloud-exclamation text-danger';
            statusText.textContent = 'Erro de Conex√£o';
            statusText.className = 'text-danger';
        }
    }

    // Fun√ß√µes de Sincroniza√ß√£o
    async function syncAll() {
        await syncOperation('Sincronizando todos os dados...', '/api/brewfather/sync/all');
    }

    async function syncRecipes() {
        await syncOperation('Sincronizando receitas...', '/api/brewfather/sync/recipes');
    }

    async function syncBatches() {
        await syncOperation('Sincronizando lotes...', '/api/brewfather/sync/batches');
    }

    async function syncInventory() {
        await syncOperation('Sincronizando estoque...', '/api/brewfather/sync/inventory');
    }

    async function syncOperation(message, url) {
        showAlert(message, 'info');

        try {
            const response = await fetch(url, { method: 'POST' });
            const result = await response.json();

            if (response.ok) {
                showAlert('Sincroniza√ß√£o conclu√≠da com sucesso!', 'success');
                loadStatus();

                // Recarregar dados relevantes
                if (url.includes('recipes')) loadRecipes();
                if (url.includes('batches')) loadBatches();
                if (url.includes('inventory')) loadInventory();

            } else {
                showAlert('Erro: ' + (result.error || 'Erro na sincroniza√ß√£o'), 'danger');
            }
        } catch (error) {
            console.error('Erro na sincroniza√ß√£o:', error);
            showAlert('Erro na sincroniza√ß√£o', 'danger');
        }
    }

    // Fun√ß√£o para buscar receitas da API
    async function fetchRecipesFromBrewFather() {
        const btn = document.getElementById('fetch-recipes-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Buscando...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/brewfather/recipes/fetch', { method: 'POST' });
            const result = await response.json();

            if (response.ok) {
                showAlert(`Encontradas ${result.count} receitas na API do BrewFather`, 'success');
                // Opcional: sincronizar ap√≥s buscar
                await syncRecipes();
            } else {
                showAlert('Erro: ' + (result.error || 'Erro ao buscar receitas'), 'danger');
            }
        } catch (error) {
            console.error('Erro ao buscar receitas:', error);
            showAlert('Erro ao buscar receitas da API', 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Fun√ß√µes de Carregamento de Dados
    async function loadRecipes(page = 1) {
        try {
            const response = await fetch(`/api/brewfather/recipes?page=${page}&per_page=${perPage}`);
            const data = await response.json();

            currentRecipesPage = page;
            renderRecipesTable(data);
            renderPagination('recipes-pagination', data, currentRecipesPage, loadRecipes);

        } catch (error) {
            console.error('Erro ao carregar receitas:', error);
        }
    }

    async function loadBatches(page = 1) {
        try {
            const response = await fetch(`/api/brewfather/batches?page=${page}&per_page=${perPage}`);
            const data = await response.json();

            currentBatchesPage = page;
            renderBatchesTable(data);
            renderPagination('batches-pagination', data, currentBatchesPage, loadBatches);

        } catch (error) {
            console.error('Erro ao carregar lotes:', error);
        }
    }

    async function loadInventory(page = 1) {
        try {
            const response = await fetch(`/api/brewfather/inventory?page=${page}&per_page=${perPage}`);
            const data = await response.json();

            currentInventoryPage = page;
            renderInventoryTable(data);
            renderPagination('inventory-pagination', data, currentInventoryPage, loadInventory);

        } catch (error) {
            console.error('Erro ao carregar estoque:', error);
        }
    }

    // Fun√ß√µes de Renderiza√ß√£o
    function renderRecipesTable(data) {
        const tbody = document.getElementById('recipes-tbody');

        if (!data.recipes || data.recipes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">Nenhuma receita encontrada</td></tr>';
            document.getElementById('calculate-cost-btn').disabled = true;
            return;
        }

        tbody.innerHTML = data.recipes.map(recipe => `
            <tr class="${selectedRecipeId === recipe.id ? 'table-primary' : ''}" onclick="selectRecipe(${recipe.id}, this)">
                <td>
                    <input type="radio" name="recipe_selection" ${selectedRecipeId === recipe.id ? 'checked' : ''} 
                           onchange="selectRecipe(${recipe.id}, this.closest('tr'))">
                </td>
                <td>${escapeHtml(recipe.name)}</td>
                <td>${escapeHtml(recipe.style || '-')}</td>
                <td>${recipe.abv ? recipe.abv.toFixed(1) + '%' : '-'}</td>
                <td>${recipe.ibu ? recipe.ibu.toFixed(0) : '-'}</td>
                <td>${recipe.color ? recipe.color.toFixed(0) + ' EBC' : '-'}</td>
                <td>${recipe.batch_size ? recipe.batch_size.toFixed(1) + 'L' : '-'}</td>
                <td>${recipe.rating ? '‚òÖ'.repeat(Math.round(recipe.rating)) : '-'}</td>
                <td>${recipe.last_brewed ? new Date(recipe.last_brewed).toLocaleDateString() : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showRecipeDetail(${recipe.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        document.getElementById('calculate-cost-btn').disabled = !selectedRecipeId;
    }

    function renderBatchesTable(data) {
        const tbody = document.getElementById('batches-tbody');

        if (!data.batches || data.batches.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">Nenhum lote encontrado</td></tr>';
            return;
        }

        tbody.innerHTML = data.batches.map(batch => `
            <tr class="${selectedBatchId === batch.id ? 'table-primary' : ''}" onclick="selectBatch(${batch.id}, this)">
                <td>
                    <input type="radio" name="batch_selection" ${selectedBatchId === batch.id ? 'checked' : ''}
                           onchange="selectBatch(${batch.id}, this.closest('tr'))">
                </td>
                <td>#${batch.batch_no}</td>
                <td>${escapeHtml(batch.recipe_name)}</td>
                <td>
                    <span class="badge ${getBatchStatusBadge(batch.status)}">
                        ${getBatchStatusText(batch.status)}
                    </span>
                </td>
                <td>${batch.brew_date ? new Date(batch.brew_date).toLocaleDateString() : '-'}</td>
                <td>${batch.measured_og ? batch.measured_og.toFixed(3) : (batch.estimated_og ? batch.estimated_og.toFixed(3) : '-')}</td>
                <td>${batch.measured_fg ? batch.measured_fg.toFixed(3) : (batch.estimated_fg ? batch.estimated_fg.toFixed(3) : '-')}</td>
                <td>${batch.measured_abv ? batch.measured_abv.toFixed(1) + '%' : (batch.estimated_abv ? batch.estimated_abv.toFixed(1) + '%' : '-')}</td>
                <td>${batch.rating ? '‚òÖ'.repeat(Math.round(batch.rating)) : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showBatchDetail(${batch.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function renderInventoryTable(data) {
        const tbody = document.getElementById('inventory-tbody');

        if (!data.inventory || data.inventory.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">Nenhum item de estoque encontrado</td></tr>';
            return;
        }

        tbody.innerHTML = data.inventory.map(item => `
            <tr class="${selectedInventoryId === item.id ? 'table-primary' : ''}" onclick="selectInventory(${item.id}, this)">
                <td>
                    <input type="radio" name="inventory_selection" ${selectedInventoryId === item.id ? 'checked' : ''}
                           onchange="selectInventory(${item.id}, this.closest('tr'))">
                </td>
                <td>${escapeHtml(item.name)}</td>
                <td>
                    <span class="badge ${getInventoryTypeBadge(item.type)}">
                        ${getInventoryTypeText(item.type)}
                    </span>
                </td>
                <td>${escapeHtml(item.category || '-')}</td>
                <td>${item.quantity ? item.quantity.toFixed(2) + ' ' + (item.unit || '') : '-'}</td>
                <td>${item.price ? 'R$ ' + item.price.toFixed(2) : '-'}</td>
                <td>${escapeHtml(item.supplier || '-')}</td>
                <td>${item.synchronized_at ? new Date(item.synchronized_at).toLocaleDateString() : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showInventoryDetail(${item.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Fun√ß√µes de Sele√ß√£o
    function selectRecipe(recipeId, row) {
        selectedRecipeId = recipeId;
        document.querySelectorAll('#recipes-tbody tr').forEach(tr => {
            tr.classList.remove('table-primary');
        });
        row.classList.add('table-primary');
        document.getElementById('calculate-cost-btn').disabled = false;
    }

    function selectBatch(batchId, row) {
        selectedBatchId = batchId;
        document.querySelectorAll('#batches-tbody tr').forEach(tr => {
            tr.classList.remove('table-primary');
        });
        row.classList.add('table-primary');
    }

    function selectInventory(inventoryId, row) {
        selectedInventoryId = inventoryId;
        document.querySelectorAll('#inventory-tbody tr').forEach(tr => {
            tr.classList.remove('table-primary');
        });
        row.classList.add('table-primary');
    }

    // Fun√ß√£o para calcular custo da receita
    async function calculateSelectedRecipeCost() {
        if (!selectedRecipeId) {
            showAlert('Selecione uma receita para calcular o custo', 'warning');
            return;
        }

        try {
            const response = await fetch(`/api/brewfather/recipe/${selectedRecipeId}`);
            const data = await response.json();
            const recipe = data.recipe;

            // Buscar pre√ßos do estoque para calcular custo
            const inventoryResponse = await fetch('/api/brewfather/inventory?per_page=1000');
            const inventoryData = await inventoryResponse.json();

            const modalBody = document.getElementById('costCalculationModalBody');
            modalBody.innerHTML = renderCostCalculation(recipe, inventoryData.inventory || []);

            document.getElementById('costCalculationModalLabel').textContent = `C√°lculo de Custo - ${recipe.name}`;
            const modal = new bootstrap.Modal(document.getElementById('costCalculationModal'));
            modal.show();

        } catch (error) {
            console.error('Erro ao calcular custo:', error);
            showAlert('Erro ao calcular custo da receita', 'danger');
        }
    }

    async function cadastrarInsumosReceita() {
        if (!selectedRecipeId) {
            showAlert('Selecione uma receita para cadastrar os insumos', 'warning');
            return;
        }

        const btn = document.querySelector('button[onclick="cadastrarInsumosReceita()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processando...';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/brewfather/recipe/${selectedRecipeId}/cadastrar-insumos`, {
                method: 'POST'
            });
            const result = await response.json();

            if (result.success) {
                // Buscar o nome da receita selecionada para mostrar na mensagem
                const selectedRow = document.querySelector('#recipes-tbody tr.table-primary');
                const recipeName = selectedRow ? selectedRow.cells[1].textContent : 'Receita selecionada';

                const mensagemDetalhada = `
                                            ‚úÖ <strong>Insumos cadastrados com sucesso!</strong><br><br>
                                            <strong>Receita:</strong> ${recipeName}<br>
                                            ${result.ingredientes_cadastrados ? `
                                            <strong>Insumos cadastrados:</strong><br>
                                            ‚Ä¢ Maltes: ${result.ingredientes_cadastrados.maltes?.length || 0}<br>
                                            ‚Ä¢ L√∫pulos: ${result.ingredientes_cadastrados.lupulos?.length || 0}<br>
                                            ‚Ä¢ Leveduras: ${result.ingredientes_cadastrados.leveduras?.length || 0}
                                            ` : result.message}
                                                        `;

                showAlert(mensagemDetalhada, 'success');
            } else {
                showAlert(`‚ùå Erro: ${result.error}`, 'danger');
            }
        } catch (error) {
            console.error('Erro ao cadastrar insumos:', error);
            showAlert('‚ùå Erro ao cadastrar insumos', 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }











    async function cadastrarTodosInsumosReceita() {
        const btn = document.querySelector('button[onclick="cadastrarTodosInsumosReceita()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processando...';
        btn.disabled = true;

        try {
            // Primeiro, buscar todas as receitas
            const recipesResponse = await fetch('/api/brewfather/recipes?per_page=1000');
            const recipesData = await recipesResponse.json();

            if (!recipesData.recipes || recipesData.recipes.length === 0) {
                showAlert('Nenhuma receita encontrada para processar', 'warning');
                return;
            }

            let totalSuccess = 0;
            let totalErrors = 0;
            let resultadosDetalhados = {
                receitas_processadas: 0,
                maltes_cadastrados: 0,
                lupulos_cadastrados: 0,
                leveduras_cadastradas: 0,
                receitas_com_erro: []
            };

            // Processar cada receita individualmente
            for (const recipe of recipesData.recipes) {
                try {
                    console.log(`Processando receita: ${recipe.name} (ID: ${recipe.id})`);

                    const response = await fetch(`/api/brewfather/recipe/${recipe.id}/cadastrar-insumos`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (result.success) {
                        totalSuccess++;
                        resultadosDetalhados.receitas_processadas++;

                        // Contabilizar ingredientes cadastrados
                        if (result.ingredientes_cadastrados) {
                            resultadosDetalhados.maltes_cadastrados += result.ingredientes_cadastrados.maltes?.length || 0;
                            resultadosDetalhados.lupulos_cadastrados += result.ingredientes_cadastrados.lupulos?.length || 0;
                            resultadosDetalhados.leveduras_cadastradas += result.ingredientes_cadastrados.leveduras?.length || 0;
                        }

                        console.log(`‚úÖ ${recipe.name}: ${result.message}`);
                    } else {
                        totalErrors++;
                        resultadosDetalhados.receitas_com_erro.push({
                            receita: recipe.name,
                            erro: result.error || 'Erro desconhecido'
                        });
                        console.log(`‚ùå ${recipe.name}: ${result.error}`);
                    }

                    // Pequena pausa para n√£o sobrecarregar o servidor
                    await new Promise(resolve => setTimeout(resolve, 500));

                } catch (error) {
                    totalErrors++;
                    resultadosDetalhados.receitas_com_erro.push({
                        receita: recipe.name,
                        erro: error.message
                    });
                    console.error(`‚ùå Erro ao processar receita ${recipe.name}:`, error);
                }
            }

            // Exibir resultado final
            const mensagemFinal = `
üéâ <strong>Processamento Conclu√≠do!</strong><br><br>
üìä <strong>Resumo:</strong><br>
‚Ä¢ Receitas processadas: ${resultadosDetalhados.receitas_processadas}<br>
‚Ä¢ Receitas com erro: ${totalErrors}<br>
‚Ä¢ Maltes cadastrados: ${resultadosDetalhados.maltes_cadastrados}<br>
‚Ä¢ L√∫pulos cadastrados: ${resultadosDetalhados.lupulos_cadastrados}<br>
‚Ä¢ Leveduras cadastradas: ${resultadosDetalhados.leveduras_cadastradas}<br><br>
${totalErrors > 0 ? `‚ö†Ô∏è <strong>Erros encontrados:</strong><br>${resultadosDetalhados.receitas_com_erro.map(e => `‚Ä¢ ${e.receita}: ${e.erro}`).join('<br>')}` : '‚úÖ Todos os insumos foram processados com sucesso!'}
        `;

            // Criar modal customizado para mostrar os resultados
            const modalHTML = `
            <div class="modal fade" id="resultadoProcessamentoModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header ${totalErrors > 0 ? 'bg-warning' : 'bg-success'} text-white">
                            <h5 class="modal-title">
                                <i class="bi ${totalErrors > 0 ? 'bi-exclamation-triangle' : 'bi-check-circle'}"></i>
                                Resultado do Processamento
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row text-center mb-4">
                                <div class="col-md-3">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <h6 class="card-title">Receitas</h6>
                                            <h3 class="text-primary">${resultadosDetalhados.receitas_processadas}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <h6 class="card-title">Maltes</h6>
                                            <h3 class="text-success">${resultadosDetalhados.maltes_cadastrados}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-info">
                                        <div class="card-body">
                                            <h6 class="card-title">L√∫pulos</h6>
                                            <h3 class="text-info">${resultadosDetalhados.lupulos_cadastrados}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning">
                                        <div class="card-body">
                                            <h6 class="card-title">Leveduras</h6>
                                            <h3 class="text-warning">${resultadosDetalhados.leveduras_cadastradas}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${totalErrors > 0 ? `
                            <div class="alert alert-warning">
                                <h6><i class="bi bi-exclamation-triangle"></i> Erros Encontrados</h6>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Receita</th>
                                                <th>Erro</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${resultadosDetalhados.receitas_com_erro.map(erro => `
                                                <tr>
                                                    <td><small>${erro.receita}</small></td>
                                                    <td><small class="text-danger">${erro.erro}</small></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Informa√ß√£o:</strong> Os insumos foram cadastrados com pre√ßo inicial de R$ 0,01. 
                                √â necess√°rio ajustar os pre√ßos manualmente para c√°lculos precisos.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            <button type="button" class="btn btn-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar P√°gina
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Adicionar o modal ao DOM e mostrar
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            const modal = new bootstrap.Modal(document.getElementById('resultadoProcessamentoModal'));
            modal.show();

            // Remover o modal do DOM quando fechar
            modalContainer.addEventListener('hidden.bs.modal', function () {
                modalContainer.remove();
            });

        } catch (error) {
            console.error('Erro geral no processamento:', error);
            showAlert(`‚ùå Erro geral no processamento: ${error.message}`, 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }











































    async function verIngredientesFaltantes() {
        try {
            const response = await fetch(`/brewfather/recipes/${selectedRecipeId}/ingredientes-faltantes`);
            const result = await response.json();

            // Exibir modal com ingredientes faltantes
            console.log('Ingredientes faltantes:', result);
        } catch (error) {
            console.error('Erro ao buscar ingredientes faltantes:', error);
        }
    }

    function renderCostCalculation(recipe, inventory) {
        let totalCost = 0;
        let ingredientsHTML = '';

        // Mapear ingredientes da receita com estoque
        if (recipe.ingredients && recipe.ingredients.fermentables) {
            ingredientsHTML += renderIngredientCostSection('Maltes e Ferment√°veis', recipe.ingredients.fermentables, inventory, 'fermentable');
        }

        if (recipe.ingredients && recipe.ingredients.hops) {
            ingredientsHTML += renderIngredientCostSection('L√∫pulos', recipe.ingredients.hops, inventory, 'hop');
        }

        if (recipe.ingredients && recipe.ingredients.yeasts) {
            ingredientsHTML += renderIngredientCostSection('Leveduras', recipe.ingredients.yeasts, inventory, 'yeast');
        }

        return `
            <div class="row">
                <div class="col-md-8">
                    <h6>Ingredientes e Custos</h6>
                    ${ingredientsHTML || '<p>Nenhum ingrediente encontrado para c√°lculo</p>'}
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h6>Resumo do Custo</h6>
                            <table class="table table-sm">
                                <tr><td>Custo Total:</td><td><strong id="total-cost">R$ 0,00</strong></td></tr>
                                <tr><td>Tamanho do Lote:</td><td>${recipe.batch_size || 0}L</td></tr>
                                <tr><td>Custo por Litro:</td><td><strong id="cost-per-liter">R$ 0,00</strong></td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderIngredientCostSection(title, ingredients, inventory, type) {
        let sectionHTML = `<h6 class="mt-3">${title}</h6><table class="table table-sm">`;
        let sectionTotal = 0;

        ingredients.forEach(ingredient => {
            const inventoryItem = inventory.find(item =>
                item.name.toLowerCase().includes(ingredient.name.toLowerCase()) &&
                item.type === type
            );

            const price = inventoryItem ? (inventoryItem.price || 0) : 0;
            const quantity = ingredient.amount || 0;
            const cost = price * quantity;
            sectionTotal += cost;

            sectionHTML += `
                <tr>
                    <td>${escapeHtml(ingredient.name)}</td>
                    <td>${quantity.toFixed(2)} ${ingredient.unit || 'kg'}</td>
                    <td>R$ ${price.toFixed(2)}</td>
                    <td>R$ ${cost.toFixed(2)}</td>
                </tr>
            `;
        });

        sectionHTML += `
            <tr class="table-secondary">
                <td colspan="3"><strong>Total ${title}:</strong></td>
                <td><strong>R$ ${sectionTotal.toFixed(2)}</strong></td>
            </tr>
        </table>`;

        return sectionHTML;
    }

    // Fun√ß√µes de Movimenta√ß√£o de Estoque
    function showInventoryMovementModal(type) {
        if (!selectedInventoryId) {
            showAlert('Selecione um item do estoque para movimenta√ß√£o', 'warning');
            return;
        }

        const selectedRow = document.querySelector(`#inventory-tbody tr.table-primary`);
        if (!selectedRow) return;

        const itemName = selectedRow.cells[1].textContent;
        const currentQuantity = selectedRow.cells[4].textContent.split(' ')[0];
        const unit = selectedRow.cells[4].textContent.split(' ')[1] || '';

        document.getElementById('movement_type').value = type;
        document.getElementById('selected_inventory_id').value = selectedInventoryId;
        document.getElementById('inventory_item').value = itemName;
        document.getElementById('movement_unit').value = unit;
        document.getElementById('movement_quantity').value = '';
        document.getElementById('movement_notes').value = '';

        const priceField = document.getElementById('price_field');
        if (type === 'entrada') {
            priceField.style.display = 'block';
            document.getElementById('inventoryMovementModalLabel').textContent = 'Entrada no Estoque';
        } else {
            priceField.style.display = 'none';
            document.getElementById('inventoryMovementModalLabel').textContent =
                type === 'saida' ? 'Sa√≠da do Estoque' : 'Ajuste de Estoque';
        }

        const modal = new bootstrap.Modal(document.getElementById('inventoryMovementModal'));
        modal.show();
    }

    async function processInventoryMovement() {
        const formData = {
            type: document.getElementById('movement_type').value,
            inventory_id: document.getElementById('selected_inventory_id').value,
            quantity: parseFloat(document.getElementById('movement_quantity').value),
            unit: document.getElementById('movement_unit').value,
            notes: document.getElementById('movement_notes').value
        };

        if (formData.type === 'entrada') {
            formData.price = parseFloat(document.getElementById('movement_price').value) || 0;
        }

        if (!formData.quantity || formData.quantity <= 0) {
            showAlert('Informe uma quantidade v√°lida', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/brewfather/inventory/movement', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                showAlert('Movimenta√ß√£o registrada com sucesso!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('inventoryMovementModal')).hide();
                loadInventory();
            } else {
                showAlert('Erro: ' + (result.error || 'Erro na movimenta√ß√£o'), 'danger');
            }
        } catch (error) {
            console.error('Erro na movimenta√ß√£o:', error);
            showAlert('Erro na movimenta√ß√£o de estoque', 'danger');
        }
    }

    // Fun√ß√µes Auxiliares (mantidas as mesmas do c√≥digo anterior)
    function renderPagination(elementId, data, currentPage, loadFunction) {
        const pagination = document.getElementById(elementId);

        if (data.pages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let paginationHTML = '';

        // Bot√£o Anterior
        if (currentPage > 1) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="${loadFunction.name}(${currentPage - 1}); return false;">Anterior</a>
                </li>
            `;
        } else {
            paginationHTML += `
                <li class="page-item disabled">
                    <span class="page-link">Anterior</span>
                </li>
            `;
        }

        // N√∫meros das p√°ginas
        for (let i = 1; i <= data.pages; i++) {
            if (i === currentPage) {
                paginationHTML += `
                    <li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>
                `;
            } else {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="${loadFunction.name}(${i}); return false;">${i}</a>
                    </li>
                `;
            }
        }

        // Bot√£o Pr√≥xima
        if (currentPage < data.pages) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="${loadFunction.name}(${currentPage + 1}); return false;">Pr√≥xima</a>
                </li>
            `;
        } else {
            paginationHTML += `
                <li class="page-item disabled">
                    <span class="page-link">Pr√≥xima</span>
                </li>
            `;
        }

        pagination.innerHTML = paginationHTML;
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function getBatchStatusBadge(status) {
        const statusMap = {
            'Planning': 'bg-secondary',
            'Brewing': 'bg-primary',
            'Fermenting': 'bg-info',
            'Conditioning': 'bg-warning',
            'Completed': 'bg-success',
            'Archived': 'bg-dark'
        };
        return statusMap[status] || 'bg-secondary';
    }

    function getBatchStatusText(status) {
        const statusMap = {
            'Planning': 'Planejamento',
            'Brewing': 'Brassagem',
            'Fermenting': 'Fermenta√ß√£o',
            'Conditioning': 'Matura√ß√£o',
            'Completed': 'Conclu√≠do',
            'Archived': 'Arquivado'
        };
        return statusMap[status] || status;
    }

    function getInventoryTypeBadge(type) {
        const typeMap = {
            'fermentable': 'bg-warning',
            'hop': 'bg-success',
            'yeast': 'bg-info',
            'misc': 'bg-secondary'
        };
        return typeMap[type] || 'bg-secondary';
    }

    function getInventoryTypeText(type) {
        const typeMap = {
            'fermentable': 'Ferment√°vel',
            'hop': 'L√∫pulo',
            'yeast': 'Levedura',
            'misc': 'Diversos'
        };
        return typeMap[type] || type;
    }

    function showAlert(message, type) {
        const container = document.getElementById('alert-container');
        const alertHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${escapeHtml(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        container.innerHTML = alertHTML;

        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
            container.innerHTML = '';
        }, 5000);
    }

    // As fun√ß√µes showRecipeDetail, showBatchDetail, showInventoryDetail, renderIngredients
    // permanecem as mesmas do c√≥digo anterior...
    async function showRecipeDetail(recipeId) {
        try {
            const response = await fetch(`/api/brewfather/recipe/${recipeId}`);
            const data = await response.json();
            const recipe = data.recipe;

            const modalBody = document.getElementById('detailModalBody');
            modalBody.innerHTML = `
                <h4>${escapeHtml(recipe.name)}</h4>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Informa√ß√µes B√°sicas</h6>
                        <table class="table table-sm">
                            <tr><td>Estilo:</td><td>${escapeHtml(recipe.style || '-')}</td></tr>
                            <tr><td>ABV:</td><td>${recipe.abv ? recipe.abv.toFixed(1) + '%' : '-'}</td></tr>
                            <tr><td>IBU:</td><td>${recipe.ibu ? recipe.ibu.toFixed(0) : '-'}</td></tr>
                            <tr><td>Cor:</td><td>${recipe.color ? recipe.color.toFixed(0) + ' EBC' : '-'}</td></tr>
                            <tr><td>Tamanho do Lote:</td><td>${recipe.batch_size ? recipe.batch_size.toFixed(1) + 'L' : '-'}</td></tr>
                            <tr><td>Efici√™ncia:</td><td>${recipe.efficiency ? recipe.efficiency.toFixed(1) + '%' : '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Gravidades</h6>
                        <table class="table table-sm">
                            <tr><td>OG Original:</td><td>${recipe.original_gravity ? recipe.original_gravity.toFixed(3) : '-'}</td></tr>
                            <tr><td>FG Original:</td><td>${recipe.final_gravity ? recipe.final_gravity.toFixed(3) : '-'}</td></tr>
                        </table>
                        
                        <h6>Estat√≠sticas</h6>
                        <table class="table table-sm">
                            <tr><td>Avalia√ß√£o:</td><td>${recipe.rating ? '‚òÖ'.repeat(Math.round(recipe.rating)) : '-'}</td></tr>
                            <tr><td>Vezes Brassada:</td><td>${recipe.brew_count || 0}</td></tr>
                            <tr><td>√öltima Brassagem:</td><td>${recipe.last_brewed ? new Date(recipe.last_brewed).toLocaleDateString() : '-'}</td></tr>
                        </table>
                    </div>
                </div>
                
                ${recipe.ingredients ? `
                <h6 class="mt-3">Ingredientes</h6>
                <div class="row">
                    ${renderIngredients(recipe.ingredients)}
                </div>
                ` : ''}
                
                ${recipe.notes ? `
                <h6 class="mt-3">Notas</h6>
                <p>${escapeHtml(recipe.notes)}</p>
                ` : ''}
            `;

            document.getElementById('detailModalLabel').textContent = 'Detalhes da Receita';
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();

        } catch (error) {
            console.error('Erro ao carregar detalhes da receita:', error);
            showAlert('Erro ao carregar detalhes da receita', 'danger');
        }
    }

    async function showBatchDetail(batchId) {
        try {
            const response = await fetch(`/api/brewfather/batch/${batchId}`);
            const data = await response.json();
            const batch = data.batch;

            const modalBody = document.getElementById('detailModalBody');
            modalBody.innerHTML = `
                <h4>Lote #${batch.batch_no} - ${escapeHtml(batch.recipe_name)}</h4>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Informa√ß√µes do Lote</h6>
                        <table class="table table-sm">
                            <tr><td>Status:</td><td><span class="badge ${getBatchStatusBadge(batch.status)}">${getBatchStatusText(batch.status)}</span></td></tr>
                            <tr><td>Data da Brassagem:</td><td>${batch.brew_date ? new Date(batch.brew_date).toLocaleDateString() : '-'}</td></tr>
                            <tr><td>Tamanho do Lote:</td><td>${batch.batch_size ? batch.batch_size.toFixed(1) + 'L' : '-'}</td></tr>
                            <tr><td>Efici√™ncia:</td><td>${batch.efficiency ? batch.efficiency.toFixed(1) + '%' : '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Medidas</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>OG Estimada:</td>
                                <td>${batch.estimated_og ? batch.estimated_og.toFixed(3) : '-'}</td>
                                <td>OG Medida:</td>
                                <td>${batch.measured_og ? batch.measured_og.toFixed(3) : '-'}</td>
                            </tr>
                            <tr>
                                <td>FG Estimada:</td>
                                <td>${batch.estimated_fg ? batch.estimated_fg.toFixed(3) : '-'}</td>
                                <td>FG Medida:</td>
                                <td>${batch.measured_fg ? batch.measured_fg.toFixed(3) : '-'}</td>
                            </tr>
                            <tr>
                                <td>ABV Estimada:</td>
                                <td>${batch.estimated_abv ? batch.estimated_abv.toFixed(1) + '%' : '-'}</td>
                                <td>ABV Medida:</td>
                                <td>${batch.measured_abv ? batch.measured_abv.toFixed(1) + '%' : '-'}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                ${batch.notes ? `
                <h6 class="mt-3">Notas</h6>
                <p>${escapeHtml(batch.notes)}</p>
                ` : ''}
                
                ${batch.rating ? `
                <h6 class="mt-3">Avalia√ß√£o</h6>
                <p>${'‚òÖ'.repeat(Math.round(batch.rating))}</p>
                ` : ''}
            `;

            document.getElementById('detailModalLabel').textContent = 'Detalhes do Lote';
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();

        } catch (error) {
            console.error('Erro ao carregar detalhes do lote:', error);
            showAlert('Erro ao carregar detalhes do lote', 'danger');
        }
    }

    async function showInventoryDetail(inventoryId) {
        try {
            const response = await fetch(`/api/brewfather/inventory/${inventoryId}`);
            const data = await response.json();
            const item = data.inventory;

            const modalBody = document.getElementById('detailModalBody');
            modalBody.innerHTML = `
                <h4>${escapeHtml(item.name)}</h4>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Informa√ß√µes do Item</h6>
                        <table class="table table-sm">
                            <tr><td>Tipo:</td><td><span class="badge ${getInventoryTypeBadge(item.type)}">${getInventoryTypeText(item.type)}</span></td></tr>
                            <tr><td>Categoria:</td><td>${escapeHtml(item.category || '-')}</td></tr>
                            <tr><td>Quantidade:</td><td>${item.quantity ? item.quantity.toFixed(2) + ' ' + (item.unit || '') : '-'}</td></tr>
                            <tr><td>Pre√ßo:</td><td>${item.price ? 'R$ ' + item.price.toFixed(2) : '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Fornecedor</h6>
                        <table class="table table-sm">
                            <tr><td>Fornecedor:</td><td>${escapeHtml(item.supplier || '-')}</td></tr>
                            <tr><td>Sincronizado em:</td><td>${item.synchronized_at ? new Date(item.synchronized_at).toLocaleDateString() : '-'}</td></tr>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('detailModalLabel').textContent = 'Detalhes do Estoque';
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();

        } catch (error) {
            console.error('Erro ao carregar detalhes do estoque:', error);
            showAlert('Erro ao carregar detalhes do estoque', 'danger');
        }
    }

    function renderIngredients(ingredients) {
        let html = '';

        if (ingredients.fermentables && ingredients.fermentables.length > 0) {
            html += `
                <div class="col-md-6">
                    <h6>Maltes</h6>
                    <table class="table table-sm">
                        ${ingredients.fermentables.map(ferm => `
                            <tr>
                                <td>${escapeHtml(ferm.name || '')}</td>
                                <td>${ferm.amount ? ferm.amount.toFixed(2) + 'kg' : ''}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }

        if (ingredients.hops && ingredients.hops.length > 0) {
            html += `
                <div class="col-md-6">
                    <h6>L√∫pulos</h6>
                    <table class="table table-sm">
                        ${ingredients.hops.map(hop => `
                            <tr>
                                <td>${escapeHtml(hop.name || '')}</td>
                                <td>${hop.amount ? hop.amount.toFixed(1) + 'g' : ''}</td>
                                <td>${hop.time ? hop.time + 'min' : ''}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }

        if (ingredients.yeasts && ingredients.yeasts.length > 0) {
            html += `
                <div class="col-12">
                    <h6>Leveduras</h6>
                    <table class="table table-sm">
                        ${ingredients.yeasts.map(yeast => `
                            <tr>
                                <td>${escapeHtml(yeast.name || '')}</td>
                                <td>${yeast.amount ? yeast.amount.toFixed(0) + ' pkg' : ''}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }

        return html || '<div class="col-12"><p>Nenhum ingrediente encontrado</p></div>';
    }

    async function saveRecipeCostCalculation() {
        // Implementar salvamento do c√°lculo de custo
        showAlert('Funcionalidade de salvamento em desenvolvimento', 'info');
    }
</script>

<style>
    .brewfather .toolbar {
        margin-bottom: 1rem;
    }

    .brewfather .toolbar .btn {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .card-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .info-card .card-body {
        padding: 1rem 1.25rem;
    }

    .info-card h6 {
        font-size: 1.1rem;
        margin-bottom: 0;
    }

    .nav-tabs-bordered .nav-link.active {
        border-bottom: 3px solid #0d6efd;
        font-weight: 600;
    }

    .table td {
        vertical-align: middle;
    }

    .badge {
        font-size: 0.75em;
    }

    .table-hover tbody tr:hover {
        cursor: pointer;
    }

    .table-primary {
        background-color: #e7f1ff !important;
    }

    @media (max-width: 768px) {
        .brewfather .toolbar .btn {
            margin-bottom: 0.5rem;
            width: 100%;
        }
    }
</style>
{% endblock %}