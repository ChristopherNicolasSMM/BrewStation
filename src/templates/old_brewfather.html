<!-- templates/brewfather.html -->
{% extends "base.html" %}

{% block title %}BrewFather - BrewStation{% endblock %}

{% block content %}
<div class="pagetitle">
    <h1>BrewFather</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
            <li class="breadcrumb-item active">BrewFather</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section brewfather">
    <div class="row">
        <div class="col-lg-12">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Integração BrewFather</h5>

                            <!-- Status da Integração -->
                            <div class="row mb-4">
                                <div class="col-xl-3 col-md-6">
                                    <div class="card info-card sales-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Status</h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-cloud-check" id="status-icon"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6 id="status-text">Verificando...</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6">
                                    <div class="card info-card revenue-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Receitas</h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-journal-text"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6 id="recipes-count">0</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6">
                                    <div class="card info-card customers-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Lotes</h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-clipboard-data"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6 id="batches-count">0</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6">
                                    <div class="card info-card customers-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Estoque</h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-box-seam"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6 id="inventory-count">0</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Barra de Ferramentas -->
                            <div class="toolbar mb-3">
                                <button class="btn btn-primary" onclick="syncAll()">
                                    <i class="bi bi-arrow-repeat"></i> Sincronizar Tudo
                                </button>
                                <button class="btn btn-success" onclick="syncRecipes()">
                                    <i class="bi bi-journal-text"></i> Sincronizar Receitas
                                </button>
                                <button class="btn btn-info" onclick="syncBatches()">
                                    <i class="bi bi-clipboard-data"></i> Sincronizar Lotes
                                </button>
                                <button class="btn btn-warning" onclick="syncInventory()">
                                    <i class="bi bi-box-seam"></i> Sincronizar Estoque
                                </button>
                                <button class="btn btn-outline-secondary" onclick="loadStatus()">
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                                </button>
                            </div>

                            <!-- Alertas -->
                            <div id="alert-container"></div>

                            <!-- Abas -->
                            <ul class="nav nav-tabs nav-tabs-bordered" id="brewfatherTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="recipes-tab" data-bs-toggle="tab" data-bs-target="#recipes" type="button" role="tab">
                                        <i class="bi bi-journal-text me-2"></i>Receitas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="batches-tab" data-bs-toggle="tab" data-bs-target="#batches" type="button" role="tab">
                                        <i class="bi bi-clipboard-data me-2"></i>Lotes
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                                        <i class="bi bi-box-seam me-2"></i>Estoque
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync" type="button" role="tab">
                                        <i class="bi bi-arrow-repeat me-2"></i>Sincronização
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content pt-3" id="brewfatherTabsContent">
                                <!-- Tab Receitas -->
                                <div class="tab-pane fade show active" id="recipes" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-striped" id="recipes-table">
                                            <thead>
                                                <tr>
                                                    <th>Nome</th>
                                                    <th>Estilo</th>
                                                    <th>ABV</th>
                                                    <th>IBU</th>
                                                    <th>Cor</th>
                                                    <th>Tamanho</th>
                                                    <th>Avaliação</th>
                                                    <th>Última Brassagem</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recipes-tbody">
                                                <!-- Dados carregados via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination justify-content-center" id="recipes-pagination">
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Tab Lotes -->
                                <div class="tab-pane fade" id="batches" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-striped" id="batches-table">
                                            <thead>
                                                <tr>
                                                    <th>Lote</th>
                                                    <th>Receita</th>
                                                    <th>Status</th>
                                                    <th>Data</th>
                                                    <th>OG</th>
                                                    <th>FG</th>
                                                    <th>ABV</th>
                                                    <th>Avaliação</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="batches-tbody">
                                                <!-- Dados carregados via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination justify-content-center" id="batches-pagination">
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Tab Estoque -->
                                <div class="tab-pane fade" id="inventory" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-striped" id="inventory-table">
                                            <thead>
                                                <tr>
                                                    <th>Nome</th>
                                                    <th>Tipo</th>
                                                    <th>Categoria</th>
                                                    <th>Quantidade</th>
                                                    <th>Preço</th>
                                                    <th>Fornecedor</th>
                                                    <th>Sincronizado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inventory-tbody">
                                                <!-- Dados carregados via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination justify-content-center" id="inventory-pagination">
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Tab Sincronização -->
                                <div class="tab-pane fade" id="sync" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Status da Sincronização</h5>
                                                    <div id="sync-status">
                                                        <!-- Status carregado via JavaScript -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Configuração</h5>
                                                    <p>Para usar a integração com BrewFather, configure suas credenciais API nas <a href="{{ url_for('main.config') }}">Configurações do Sistema</a>.</p>
                                                    <div class="alert alert-info">
                                                        <h6>Como obter as credenciais:</h6>
                                                        <ol class="small">
                                                            <li>Acesse seu perfil no BrewFather</li>
                                                            <li>Vá em Settings → API</li>
                                                            <li>Copie o User ID e API Key</li>
                                                            <li>Cole nas configurações do sistema</li>
                                                            <li>Ative a integração</li>
                                                        </ol>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal para Detalhes -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Detalhes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailModalBody">
                <!-- Conteúdo carregado via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Variáveis globais
    let currentRecipesPage = 1;
    let currentBatchesPage = 1;
    let currentInventoryPage = 1;
    const perPage = 10;

    // Carregar dados ao iniciar
    document.addEventListener('DOMContentLoaded', function() {
        loadStatus();
        loadRecipes();
        loadBatches();
        loadInventory();
        
        // Atualizar a cada 30 segundos
        setInterval(loadStatus, 30000);
    });

    // Funções de Status
    async function loadStatus() {
        try {
            const response = await fetch('/api/brewfather/status');
            const data = await response.json();
            
            updateStatusDisplay(data);
            updateCounts(data);
            
        } catch (error) {
            console.error('Erro ao carregar status:', error);
            showAlert('Erro ao carregar status do BrewFather', 'danger');
        }
    }

    function updateStatusDisplay(status) {
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        
        if (!status.enabled) {
            statusIcon.className = 'bi bi-cloud-slash text-danger';
            statusText.textContent = 'Desativado';
            statusText.className = 'text-danger';
        } else if (!status.configured) {
            statusIcon.className = 'bi bi-cloud-exclamation text-warning';
            statusText.textContent = 'Não Configurado';
            statusText.className = 'text-warning';
        } else if (status.connection_test) {
            statusIcon.className = 'bi bi-cloud-check text-success';
            statusText.textContent = 'Conectado';
            statusText.className = 'text-success';
        } else {
            statusIcon.className = 'bi bi-cloud-exclamation text-danger';
            statusText.textContent = 'Erro de Conexão';
            statusText.className = 'text-danger';
        }
    }

    function updateCounts(status) {
        // Esta função será expandida quando tivermos as contagens reais
        document.getElementById('recipes-count').textContent = '...';
        document.getElementById('batches-count').textContent = '...';
        document.getElementById('inventory-count').textContent = '...';
    }

    // Funções de Sincronização
    async function syncAll() {
        await syncOperation('Sincronizando todos os dados...', '/api/brewfather/sync/all');
    }

    async function syncRecipes() {
        await syncOperation('Sincronizando receitas...', '/api/brewfather/sync/recipes');
    }

    async function syncBatches() {
        await syncOperation('Sincronizando lotes...', '/api/brewfather/sync/batches');
    }

    async function syncInventory() {
        await syncOperation('Sincronizando estoque...', '/api/brewfather/sync/inventory');
    }

    async function syncOperation(message, url) {
        showAlert(message, 'info');
        
        try {
            const response = await fetch(url, { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message, 'success');
                loadStatus();
                
                // Recarregar dados relevantes
                if (url.includes('recipes')) loadRecipes();
                if (url.includes('batches')) loadBatches();
                if (url.includes('inventory')) loadInventory();
                
            } else {
                showAlert('Erro: ' + result.error, 'danger');
            }
        } catch (error) {
            console.error('Erro na sincronização:', error);
            showAlert('Erro na sincronização', 'danger');
        }
    }

    // Funções de Carregamento de Dados
    async function loadRecipes(page = 1) {
        try {
            const response = await fetch(`/api/brewfather/recipes?page=${page}&per_page=${perPage}`);
            const data = await response.json();
            
            renderRecipesTable(data);
            renderPagination('recipes-pagination', data, currentRecipesPage, loadRecipes);
            
        } catch (error) {
            console.error('Erro ao carregar receitas:', error);
        }
    }

    async function loadBatches(page = 1) {
        try {
            const response = await fetch(`/api/brewfather/batches?page=${page}&per_page=${perPage}`);
            const data = await response.json();
            
            renderBatchesTable(data);
            renderPagination('batches-pagination', data, currentBatchesPage, loadBatches);
            
        } catch (error) {
            console.error('Erro ao carregar lotes:', error);
        }
    }

    async function loadInventory(page = 1) {
        try {
            const response = await fetch(`/api/brewfather/inventory?page=${page}&per_page=${perPage}`);
            const data = await response.json();
            
            renderInventoryTable(data);
            renderPagination('inventory-pagination', data, currentInventoryPage, loadInventory);
            
        } catch (error) {
            console.error('Erro ao carregar estoque:', error);
        }
    }

    // Funções de Renderização
    function renderRecipesTable(data) {
        const tbody = document.getElementById('recipes-tbody');
        
        if (!data.recipes || data.recipes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">Nenhuma receita encontrada</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.recipes.map(recipe => `
            <tr>
                <td>${escapeHtml(recipe.name)}</td>
                <td>${escapeHtml(recipe.style || '-')}</td>
                <td>${recipe.abv ? recipe.abv.toFixed(1) + '%' : '-'}</td>
                <td>${recipe.ibu ? recipe.ibu.toFixed(0) : '-'}</td>
                <td>${recipe.color ? recipe.color.toFixed(0) + ' EBC' : '-'}</td>
                <td>${recipe.batch_size ? recipe.batch_size.toFixed(1) + 'L' : '-'}</td>
                <td>${recipe.rating ? '★'.repeat(Math.round(recipe.rating)) : '-'}</td>
                <td>${recipe.last_brewed ? new Date(recipe.last_brewed).toLocaleDateString() : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showRecipeDetail(${recipe.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function renderBatchesTable(data) {
        const tbody = document.getElementById('batches-tbody');
        
        if (!data.batches || data.batches.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">Nenhum lote encontrado</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.batches.map(batch => `
            <tr>
                <td>#${batch.batch_no}</td>
                <td>${escapeHtml(batch.recipe_name)}</td>
                <td>
                    <span class="badge ${getBatchStatusBadge(batch.status)}">
                        ${getBatchStatusText(batch.status)}
                    </span>
                </td>
                <td>${batch.brew_date ? new Date(batch.brew_date).toLocaleDateString() : '-'}</td>
                <td>${batch.measured_og ? batch.measured_og.toFixed(3) : (batch.estimated_og ? batch.estimated_og.toFixed(3) : '-')}</td>
                <td>${batch.measured_fg ? batch.measured_fg.toFixed(3) : (batch.estimated_fg ? batch.estimated_fg.toFixed(3) : '-')}</td>
                <td>${batch.measured_abv ? batch.measured_abv.toFixed(1) + '%' : (batch.estimated_abv ? batch.estimated_abv.toFixed(1) + '%' : '-')}</td>
                <td>${batch.rating ? '★'.repeat(Math.round(batch.rating)) : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showBatchDetail(${batch.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function renderInventoryTable(data) {
        const tbody = document.getElementById('inventory-tbody');
        
        if (!data.inventory || data.inventory.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum item de estoque encontrado</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.inventory.map(item => `
            <tr>
                <td>${escapeHtml(item.name)}</td>
                <td>
                    <span class="badge ${getInventoryTypeBadge(item.type)}">
                        ${getInventoryTypeText(item.type)}
                    </span>
                </td>
                <td>${escapeHtml(item.category || '-')}</td>
                <td>${item.quantity ? item.quantity.toFixed(2) + ' ' + (item.unit || '') : '-'}</td>
                <td>${item.price ? 'R$ ' + item.price.toFixed(2) : '-'}</td>
                <td>${escapeHtml(item.supplier || '-')}</td>
                <td>${item.synchronized_at ? new Date(item.synchronized_at).toLocaleDateString() : '-'}</td>
            </tr>
        `).join('');
    }

    function renderPagination(elementId, data, currentPage, loadFunction) {
        const pagination = document.getElementById(elementId);
        
        if (data.pages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Botão Anterior
        if (currentPage > 1) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="${loadFunction.name}(${currentPage - 1}); return false;">Anterior</a>
                </li>
            `;
        } else {
            paginationHTML += `
                <li class="page-item disabled">
                    <span class="page-link">Anterior</span>
                </li>
            `;
        }
        
        // Números das páginas
        for (let i = 1; i <= data.pages; i++) {
            if (i === currentPage) {
                paginationHTML += `
                    <li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>
                `;
            } else {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="${loadFunction.name}(${i}); return false;">${i}</a>
                    </li>
                `;
            }
        }
        
        // Botão Próxima
        if (currentPage < data.pages) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="${loadFunction.name}(${currentPage + 1}); return false;">Próxima</a>
                </li>
            `;
        } else {
            paginationHTML += `
                <li class="page-item disabled">
                    <span class="page-link">Próxima</span>
                </li>
            `;
        }
        
        pagination.innerHTML = paginationHTML;
    }

    // Funções Auxiliares
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function getBatchStatusBadge(status) {
        const statusMap = {
            'Planning': 'bg-secondary',
            'Brewing': 'bg-primary',
            'Fermenting': 'bg-info',
            'Conditioning': 'bg-warning',
            'Completed': 'bg-success',
            'Archived': 'bg-dark'
        };
        return statusMap[status] || 'bg-secondary';
    }

    function getBatchStatusText(status) {
        const statusMap = {
            'Planning': 'Planejamento',
            'Brewing': 'Brassagem',
            'Fermenting': 'Fermentação',
            'Conditioning': 'Maturação',
            'Completed': 'Concluído',
            'Archived': 'Arquivado'
        };
        return statusMap[status] || status;
    }

    function getInventoryTypeBadge(type) {
        const typeMap = {
            'fermentable': 'bg-warning',
            'hop': 'bg-success',
            'yeast': 'bg-info',
            'misc': 'bg-secondary'
        };
        return typeMap[type] || 'bg-secondary';
    }

    function getInventoryTypeText(type) {
        const typeMap = {
            'fermentable': 'Fermentável',
            'hop': 'Lúpulo',
            'yeast': 'Levedura',
            'misc': 'Diversos'
        };
        return typeMap[type] || type;
    }

    function showAlert(message, type) {
        const container = document.getElementById('alert-container');
        const alertHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${escapeHtml(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        container.innerHTML = alertHTML;
        
        // Auto-remover após 5 segundos
        setTimeout(() => {
            container.innerHTML = '';
        }, 5000);
    }

    // Funções de Detalhes
    async function showRecipeDetail(recipeId) {
        try {
            const response = await fetch(`/api/brewfather/recipe/${recipeId}`);
            const data = await response.json();
            const recipe = data.recipe;
            
            const modalBody = document.getElementById('detailModalBody');
            modalBody.innerHTML = `
                <h4>${escapeHtml(recipe.name)}</h4>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Informações Básicas</h6>
                        <table class="table table-sm">
                            <tr><td>Estilo:</td><td>${escapeHtml(recipe.style || '-')}</td></tr>
                            <tr><td>ABV:</td><td>${recipe.abv ? recipe.abv.toFixed(1) + '%' : '-'}</td></tr>
                            <tr><td>IBU:</td><td>${recipe.ibu ? recipe.ibu.toFixed(0) : '-'}</td></tr>
                            <tr><td>Cor:</td><td>${recipe.color ? recipe.color.toFixed(0) + ' EBC' : '-'}</td></tr>
                            <tr><td>Tamanho do Lote:</td><td>${recipe.batch_size ? recipe.batch_size.toFixed(1) + 'L' : '-'}</td></tr>
                            <tr><td>Eficiência:</td><td>${recipe.efficiency ? recipe.efficiency.toFixed(1) + '%' : '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Gravidades</h6>
                        <table class="table table-sm">
                            <tr><td>OG Original:</td><td>${recipe.original_gravity ? recipe.original_gravity.toFixed(3) : '-'}</td></tr>
                            <tr><td>FG Original:</td><td>${recipe.final_gravity ? recipe.final_gravity.toFixed(3) : '-'}</td></tr>
                        </table>
                        
                        <h6>Estatísticas</h6>
                        <table class="table table-sm">
                            <tr><td>Avaliação:</td><td>${recipe.rating ? '★'.repeat(Math.round(recipe.rating)) : '-'}</td></tr>
                            <tr><td>Vezes Brassada:</td><td>${recipe.brew_count || 0}</td></tr>
                            <tr><td>Última Brassagem:</td><td>${recipe.last_brewed ? new Date(recipe.last_brewed).toLocaleDateString() : '-'}</td></tr>
                        </table>
                    </div>
                </div>
                
                ${recipe.ingredients ? `
                <h6 class="mt-3">Ingredientes</h6>
                <div class="row">
                    ${renderIngredients(recipe.ingredients)}
                </div>
                ` : ''}
                
                ${recipe.notes ? `
                <h6 class="mt-3">Notas</h6>
                <p>${escapeHtml(recipe.notes)}</p>
                ` : ''}
            `;
            
            document.getElementById('detailModalLabel').textContent = 'Detalhes da Receita';
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
            
        } catch (error) {
            console.error('Erro ao carregar detalhes da receita:', error);
            showAlert('Erro ao carregar detalhes da receita', 'danger');
        }
    }

    async function showBatchDetail(batchId) {
        try {
            const response = await fetch(`/api/brewfather/batch/${batchId}`);
            const data = await response.json();
            const batch = data.batch;
            
            const modalBody = document.getElementById('detailModalBody');
            modalBody.innerHTML = `
                <h4>Lote #${batch.batch_no} - ${escapeHtml(batch.recipe_name)}</h4>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Informações do Lote</h6>
                        <table class="table table-sm">
                            <tr><td>Status:</td><td><span class="badge ${getBatchStatusBadge(batch.status)}">${getBatchStatusText(batch.status)}</span></td></tr>
                            <tr><td>Data da Brassagem:</td><td>${batch.brew_date ? new Date(batch.brew_date).toLocaleDateString() : '-'}</td></tr>
                            <tr><td>Tamanho do Lote:</td><td>${batch.batch_size ? batch.batch_size.toFixed(1) + 'L' : '-'}</td></tr>
                            <tr><td>Eficiência:</td><td>${batch.efficiency ? batch.efficiency.toFixed(1) + '%' : '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Medidas</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>OG Estimada:</td>
                                <td>${batch.estimated_og ? batch.estimated_og.toFixed(3) : '-'}</td>
                                <td>OG Medida:</td>
                                <td>${batch.measured_og ? batch.measured_og.toFixed(3) : '-'}</td>
                            </tr>
                            <tr>
                                <td>FG Estimada:</td>
                                <td>${batch.estimated_fg ? batch.estimated_fg.toFixed(3) : '-'}</td>
                                <td>FG Medida:</td>
                                <td>${batch.measured_fg ? batch.measured_fg.toFixed(3) : '-'}</td>
                            </tr>
                            <tr>
                                <td>ABV Estimada:</td>
                                <td>${batch.estimated_abv ? batch.estimated_abv.toFixed(1) + '%' : '-'}</td>
                                <td>ABV Medida:</td>
                                <td>${batch.measured_abv ? batch.measured_abv.toFixed(1) + '%' : '-'}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                ${batch.notes ? `
                <h6 class="mt-3">Notas</h6>
                <p>${escapeHtml(batch.notes)}</p>
                ` : ''}
                
                ${batch.rating ? `
                <h6 class="mt-3">Avaliação</h6>
                <p>${'★'.repeat(Math.round(batch.rating))}</p>
                ` : ''}
            `;
            
            document.getElementById('detailModalLabel').textContent = 'Detalhes do Lote';
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
            
        } catch (error) {
            console.error('Erro ao carregar detalhes do lote:', error);
            showAlert('Erro ao carregar detalhes do lote', 'danger');
        }
    }

    function renderIngredients(ingredients) {
        let html = '';
        
        if (ingredients.fermentables && ingredients.fermentables.length > 0) {
            html += `
                <div class="col-md-6">
                    <h6>Maltes</h6>
                    <table class="table table-sm">
                        ${ingredients.fermentables.map(ferm => `
                            <tr>
                                <td>${escapeHtml(ferm.name || '')}</td>
                                <td>${ferm.amount ? ferm.amount.toFixed(2) + 'kg' : ''}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }
        
        if (ingredients.hops && ingredients.hops.length > 0) {
            html += `
                <div class="col-md-6">
                    <h6>Lúpulos</h6>
                    <table class="table table-sm">
                        ${ingredients.hops.map(hop => `
                            <tr>
                                <td>${escapeHtml(hop.name || '')}</td>
                                <td>${hop.amount ? hop.amount.toFixed(1) + 'g' : ''}</td>
                                <td>${hop.time ? hop.time + 'min' : ''}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }
        
        if (ingredients.yeasts && ingredients.yeasts.length > 0) {
            html += `
                <div class="col-12">
                    <h6>Leveduras</h6>
                    <table class="table table-sm">
                        ${ingredients.yeasts.map(yeast => `
                            <tr>
                                <td>${escapeHtml(yeast.name || '')}</td>
                                <td>${yeast.amount ? yeast.amount.toFixed(0) + ' pkg' : ''}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }
        
        return html || '<div class="col-12"><p>Nenhum ingrediente encontrado</p></div>';
    }
</script>

<style>
    .brewfather .toolbar {
        margin-bottom: 1rem;
    }

    .brewfather .toolbar .btn {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .card-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .info-card .card-body {
        padding: 1rem 1.25rem;
    }

    .info-card h6 {
        font-size: 1.1rem;
        margin-bottom: 0;
    }

    .nav-tabs-bordered .nav-link.active {
        border-bottom: 3px solid #0d6efd;
        font-weight: 600;
    }

    .table td {
        vertical-align: middle;
    }

    .badge {
        font-size: 0.75em;
    }

    @media (max-width: 768px) {
        .brewfather .toolbar .btn {
            margin-bottom: 0.5rem;
            width: 100%;
        }
    }
</style>
{% endblock %}