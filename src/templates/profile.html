{% extends "base.html" %}

{% block title %}Perfil do Usuário - BrewStation{% endblock %}

{% block content %}
<div class="pagetitle">
  <h1>Perfil</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
      <li class="breadcrumb-item">Usuários</li>
      <li class="breadcrumb-item active">Perfil</li>
    </ol>
  </nav>
</div><!-- End Page Title -->

<section class="section profile">
  <div class="row">
    <div class="col-xl-4">

      <div class="card">
        <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
          <img src="{{ url_for('static', filename=current_user.foto_perfil) if current_user.foto_perfil else url_for('static', filename='assets/img/profile-img.jpg') }}" alt="Profile" class="rounded-circle">
          <h2>{{ current_user.nome or 'Usuário' }}</h2>
          <h3>{{ current_user.cargo or 'Usuário' }}</h3>
          <div class="social-links mt-2">
            <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
            <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
            <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
            <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
      </div>

    </div>

    <div class="col-xl-8">

      <div class="card">
        <div class="card-body pt-3">
          <!-- Bordered Tabs -->
          <ul class="nav nav-tabs nav-tabs-bordered">

            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profile-overview">Visão Geral</button>
            </li>

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-edit">Editar Perfil</button>
            </li>

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-settings">Configurações</button>
            </li>

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-change-password">Alterar Senha</button>
            </li>

          </ul>
          <div class="tab-content pt-2">

            <div class="tab-pane fade show active profile-overview" id="profile-overview">
              <h5 class="card-title">Sobre</h5>
              <p class="small fst-italic">{{ current_user.sobre or 'Nenhuma informação adicional fornecida.' }}</p>

              <h5 class="card-title">Detalhes do Perfil</h5>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">Nome Completo</div>
                <div class="col-lg-9 col-md-8">{{ current_user.nome_completo or 'Não informado' }}</div>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">Empresa</div>
                <div class="col-lg-9 col-md-8">{{ current_user.empresa or 'Não informado' }}</div>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">Cargo</div>
                <div class="col-lg-9 col-md-8">{{ current_user.cargo or 'Não informado' }}</div>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">País</div>
                <div class="col-lg-9 col-md-8">{{ current_user.pais or 'Brasil' }}</div>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">Endereço</div>
                <div class="col-lg-9 col-md-8">{{ current_user.endereco or 'Não informado' }}</div>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">Telefone</div>
                <div class="col-lg-9 col-md-8">{{ current_user.telefone or 'Não informado' }}</div>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">Email</div>
                <div class="col-lg-9 col-md-8">{{ current_user.email }}</div>
              </div>

            </div>

            <div class="tab-pane fade profile-edit pt-3" id="profile-edit">

              <!-- Profile Edit Form -->
              <form method="POST" action="{{ url_for('main.atualizar_perfil') }}" enctype="multipart/form-data">
                <div class="row mb-3">
                  <label for="profileImage" class="col-md-4 col-lg-3 col-form-label">Imagem do Perfil</label>
                  <div class="col-md-8 col-lg-9">
                    <img src="{{ url_for('static', filename=current_user.foto_perfil) if current_user.foto_perfil else url_for('static', filename='assets/img/profile-img.jpg') }}" alt="Profile" id="profile-preview">
                    <div class="pt-2">
                      <input type="file" id="profileImage" name="profileImage" accept="image/*" style="display: none;">
                      <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('profileImage').click()">
                        <i class="bi bi-upload"></i> Upload
                      </button>
                      <button type="button" class="btn btn-danger btn-sm" onclick="removerImagem()">
                        <i class="bi bi-trash"></i> Remover
                      </button>
                    </div>
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="fullName" class="col-md-4 col-lg-3 col-form-label">Nome Completo</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="fullName" type="text" class="form-control" id="fullName" value="{{ current_user.nome_completo or '' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="about" class="col-md-4 col-lg-3 col-form-label">Sobre</label>
                  <div class="col-md-8 col-lg-9">
                    <textarea name="about" class="form-control" id="about" style="height: 100px">{{ current_user.sobre or '' }}</textarea>
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="company" class="col-md-4 col-lg-3 col-form-label">Empresa</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="company" type="text" class="form-control" id="company" value="{{ current_user.empresa or '' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Job" class="col-md-4 col-lg-3 col-form-label">Cargo</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="job" type="text" class="form-control" id="Job" value="{{ current_user.cargo or '' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Country" class="col-md-4 col-lg-3 col-form-label">País</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="country" type="text" class="form-control" id="Country" value="{{ current_user.pais or 'Brasil' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Address" class="col-md-4 col-lg-3 col-form-label">Endereço</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="address" type="text" class="form-control" id="Address" value="{{ current_user.endereco or '' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Phone" class="col-md-4 col-lg-3 col-form-label">Telefone</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="phone" type="text" class="form-control" id="Phone" value="{{ current_user.telefone or '' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Email" class="col-md-4 col-lg-3 col-form-label">Email</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="email" type="email" class="form-control" id="Email" value="{{ current_user.email }}" readonly>
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Twitter" class="col-md-4 col-lg-3 col-form-label">Twitter</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="twitter" type="text" class="form-control" id="Twitter" value="{{ current_user.twitter or '' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Facebook" class="col-md-4 col-lg-3 col-form-label">Facebook</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="facebook" type="text" class="form-control" id="Facebook" value="{{ current_user.facebook or '' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Instagram" class="col-md-4 col-lg-3 col-form-label">Instagram</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="instagram" type="text" class="form-control" id="Instagram" value="{{ current_user.instagram or '' }}">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Linkedin" class="col-md-4 col-lg-3 col-form-label">Linkedin</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="linkedin" type="text" class="form-control" id="Linkedin" value="{{ current_user.linkedin or '' }}">
                  </div>
                </div>

                <div class="text-center">
                  <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
              </form><!-- End Profile Edit Form -->

            </div>

            <div class="tab-pane fade pt-3" id="profile-settings">

              <!-- Settings Form -->
              <form method="POST" action="{{ url_for('main.atualizar_configuracoes') }}">

                <div class="row mb-3">
                  <label for="fullName" class="col-md-4 col-lg-3 col-form-label">Notificações por Email</label>
                  <div class="col-md-8 col-lg-9">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="changesMade" name="notificacao_alteracoes" {% if current_user.notificacao_alteracoes %}checked{% endif %}>
                      <label class="form-check-label" for="changesMade">
                        Alterações na sua conta
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="newProducts" name="notificacao_novos_produtos" {% if current_user.notificacao_novos_produtos %}checked{% endif %}>
                      <label class="form-check-label" for="newProducts">
                        Informações sobre novos produtos e serviços
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="proOffers" name="notificacao_ofertas" {% if current_user.notificacao_ofertas %}checked{% endif %}>
                      <label class="form-check-label" for="proOffers">
                        Ofertas de marketing e promoções
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="securityNotify" checked disabled>
                      <label class="form-check-label" for="securityNotify">
                        Alertas de segurança
                      </label>
                    </div>
                  </div>
                </div>

                <div class="text-center">
                  <button type="submit" class="btn btn-primary">Salvar Configurações</button>
                </div>
              </form><!-- End settings Form -->

            </div>

            <div class="tab-pane fade pt-3" id="profile-change-password">
              <!-- Change Password Form -->
              <form method="POST" action="{{ url_for('main.alterar_senha') }}">

                <div class="row mb-3">
                  <label for="currentPassword" class="col-md-4 col-lg-3 col-form-label">Senha Atual</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="currentPassword" type="password" class="form-control" id="currentPassword" required>
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="newPassword" class="col-md-4 col-lg-3 col-form-label">Nova Senha</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="newPassword" type="password" class="form-control" id="newPassword" required>
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="renewPassword" class="col-md-4 col-lg-3 col-form-label">Confirmar Nova Senha</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="renewPassword" type="password" class="form-control" id="renewPassword" required>
                  </div>
                </div>

                <div class="text-center">
                  <button type="submit" class="btn btn-primary">Alterar Senha</button>
                </div>
              </form><!-- End Change Password Form -->

            </div>

          </div><!-- End Bordered Tabs -->

        </div>
      </div>

    </div>
  </div>
</section>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<script>
// Preview da imagem do perfil
document.getElementById('profileImage').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('profile-preview').src = e.target.result;
    }
    reader.readAsDataURL(file);
  }
});

function removerImagem() {
  document.getElementById('profile-preview').src = "{{ url_for('static', filename='assets/img/profile-img.jpg') }}";
  document.getElementById('profileImage').value = '';
}

// Validação do formulário de senha
document.querySelector('form[action*="alterar_senha"]').addEventListener('submit', function(e) {
  const newPassword = document.getElementById('newPassword').value;
  const renewPassword = document.getElementById('renewPassword').value;
  
  if (newPassword !== renewPassword) {
    e.preventDefault();
    alert('As senhas não coincidem!');
    return false;
  }
  
  if (newPassword.length < 6) {
    e.preventDefault();
    alert('A senha deve ter pelo menos 6 caracteres!');
    return false;
  }
});
</script>

<style>
.profile-card img {
  width: 120px;
  height: 120px;
  object-fit: cover;
}

.label {
  font-weight: 600;
  color: #6c757d;
}

.nav-tabs-bordered .nav-link.active {
  border-bottom: 3px solid #0d6efd;
  font-weight: 600;
}

.form-check-label {
  font-weight: normal;
}

.alert {
  margin-bottom: 1rem;
}
</style>
{% endblock %}