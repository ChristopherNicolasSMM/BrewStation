{% extends "base.html" %}

{% block title %}Perfil do Usuário - BrewStation{% endblock %}

{% block content %}
<div class="pagetitle">
    <h1>Perfil</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
            <li class="breadcrumb-item">Usuários</li>
            <li class="breadcrumb-item active">Perfil</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section profile">
    <div class="row">
        <div class="col-xl-4">

            <div class="card">
                <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                    <img src="{{ url_for('static', filename=current_user.foto_perfil) if (current_user.is_authenticated and current_user.foto_perfil) else url_for('static', filename='img/foto-padrao-perfil.png') }}"
                        alt="Profile" class="rounded-circle profile-page-img">
                    <h2>{{ current_user.nome or 'Usuário' }}</h2>
                    <h3>{{ current_user.cargo or 'Usuário' }}</h3>
                    <div class="social-links mt-2">
                        {% if current_user.twitter %}
                        <a href="{{ current_user.twitter }}" class="twitter" target="_blank"><i
                                class="bi bi-twitter"></i></a>
                        {% else %}
                        <a href="#" class="twitter disabled"><i class="bi bi-twitter"></i></a>
                        {% endif %}

                        {% if current_user.facebook %}
                        <a href="{{ current_user.facebook }}" class="facebook" target="_blank"><i
                                class="bi bi-facebook"></i></a>
                        {% else %}
                        <a href="#" class="facebook disabled"><i class="bi bi-facebook"></i></a>
                        {% endif %}

                        {% if current_user.instagram %}
                        <a href="{{ current_user.instagram }}" class="instagram" target="_blank"><i
                                class="bi bi-instagram"></i></a>
                        {% else %}
                        <a href="#" class="instagram disabled"><i class="bi bi-instagram"></i></a>
                        {% endif %}

                        {% if current_user.linkedin %}
                        <a href="{{ current_user.linkedin }}" class="linkedin" target="_blank"><i
                                class="bi bi-linkedin"></i></a>
                        {% else %}
                        <a href="#" class="linkedin disabled"><i class="bi bi-linkedin"></i></a>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>

        <div class="col-xl-8">

            <div class="card">
                <div class="card-body pt-3">
                    <!-- Bordered Tabs -->
                    <ul class="nav nav-tabs nav-tabs-bordered">

                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab"
                                data-bs-target="#profile-overview">Visão Geral</button>
                        </li>

                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-edit">Editar
                                Perfil</button>
                        </li>

                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab"
                                data-bs-target="#profile-settings">Configurações</button>
                        </li>

                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab"
                                data-bs-target="#profile-change-password">Alterar Senha</button>
                        </li>

                    </ul>
                    <div class="tab-content pt-2">

                        <div class="tab-pane fade show active profile-overview" id="profile-overview">
                            <h5 class="card-title">Sobre</h5>
                            <p class="small fst-italic">{{ current_user.sobre or 'Nenhuma informação adicional
                                fornecida.' }}</p>

                            <h5 class="card-title">Detalhes do Perfil</h5>

                            <div class="row">
                                <div class="col-lg-3 col-md-4 label ">Nome Completo</div>
                                <div class="col-lg-9 col-md-8">{{ current_user.nome_completo or 'Não informado' }}</div>
                            </div>

                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Empresa</div>
                                <div class="col-lg-9 col-md-8">{{ current_user.empresa or 'Não informado' }}</div>
                            </div>

                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Cargo</div>
                                <div class="col-lg-9 col-md-8">{{ current_user.cargo or 'Não informado' }}</div>
                            </div>

                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">País</div>
                                <div class="col-lg-9 col-md-8">{{ current_user.pais or 'Brasil' }}</div>
                            </div>

                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Endereço</div>
                                <div class="col-lg-9 col-md-8">{{ current_user.endereco or 'Não informado' }}</div>
                            </div>

                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Telefone</div>
                                <div class="col-lg-9 col-md-8">{{ current_user.telefone or 'Não informado' }}</div>
                            </div>

                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Email</div>
                                <div class="col-lg-9 col-md-8">{{ current_user.email }}</div>
                            </div>

                        </div>

                        <div class="tab-pane fade profile-edit pt-3" id="profile-edit">

                            <!-- Profile Edit Form -->
                            <form method="POST" action="{{ url_for('main.atualizar_perfil') }}"
                                enctype="multipart/form-data">









                                <div class="row mb-3">
                                    <label for="profileImage" class="col-md-4 col-lg-3 col-form-label">Imagem do
                                        Perfil</label>
                                    <div class="col-md-8 col-lg-9">
                                        <img src="{{ url_for('static', filename=current_user.foto_perfil) if (current_user.is_authenticated and current_user.foto_perfil) else url_for('static', filename='img/foto-padrao-perfil') }}"
                                            alt="Profile" id="profile-preview" class="rounded-circle profile-page-img mb-2">
                                        <div class="pt-2">
                                            <input type="file" id="profileImage" name="profileImage" accept="image/*"
                                                style="display: none;">
                                            <button type="button" class="btn btn-primary btn-sm"
                                                onclick="document.getElementById('profileImage').click()">
                                                <i class="bi bi-upload"></i> Upload
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm"
                                                onclick="removerImagem()">
                                                <i class="bi bi-trash"></i> Remover
                                            </button>
                                            <small class="form-text text-muted d-block mt-1">
                                                Formatos suportados: JPG, PNG, GIF. Tamanho máximo: 5MB.
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <script>
                                    // Fallback para imagem quebrada
                                    document.getElementById('profile-preview').addEventListener('error', function () {
                                        this.src = "{{ url_for('static', filename='img/foto-padrao-perfil') }}";
                                    });

                                    function removerImagem() {
                                        document.getElementById('profile-preview').src = "{{ url_for('static', filename='img/foto-padrao-perfil') }}";
                                        document.getElementById('profileImage').value = '';
                                    }
                                </script>










                                <div class="row mb-3">
                                    <label for="fullName" class="col-md-4 col-lg-3 col-form-label">Nome Completo</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="fullName" type="text" class="form-control" id="fullName"
                                            value="{{ current_user.nome_completo or '' }}">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="about" class="col-md-4 col-lg-3 col-form-label">Sobre</label>
                                    <div class="col-md-8 col-lg-9">
                                        <textarea name="about" class="form-control" id="about" style="height: 100px"
                                            placeholder="Conte um pouco sobre você...">{{ current_user.sobre or '' }}</textarea>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="company" class="col-md-4 col-lg-3 col-form-label">Empresa</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="company" type="text" class="form-control" id="company"
                                            value="{{ current_user.empresa or '' }}" placeholder="Nome da sua empresa">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Job" class="col-md-4 col-lg-3 col-form-label">Cargo</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="job" type="text" class="form-control" id="Job"
                                            value="{{ current_user.cargo or '' }}" placeholder="Seu cargo ou função">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Country" class="col-md-4 col-lg-3 col-form-label">País</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="country" type="text" class="form-control" id="Country"
                                            value="{{ current_user.pais or 'Brasil' }}">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Address" class="col-md-4 col-lg-3 col-form-label">Endereço</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="address" type="text" class="form-control" id="Address"
                                            value="{{ current_user.endereco or '' }}"
                                            placeholder="Seu endereço completo">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Phone" class="col-md-4 col-lg-3 col-form-label">Telefone</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="phone" type="text" class="form-control" id="Phone"
                                            value="{{ current_user.telefone or '' }}" placeholder="(00) 00000-0000">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Email" class="col-md-4 col-lg-3 col-form-label">Email</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="email" type="email" class="form-control" id="Email"
                                            value="{{ current_user.email }}" readonly>
                                        <small class="form-text text-muted">Para alterar o email, entre em contato com o
                                            administrador.</small>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Twitter" class="col-md-4 col-lg-3 col-form-label">Twitter
                                        Profile</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="twitter" type="url" class="form-control" id="Twitter"
                                            value="{{ current_user.twitter or '' }}"
                                            placeholder="https://twitter.com/seuusuario">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Facebook" class="col-md-4 col-lg-3 col-form-label">Facebook
                                        Profile</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="facebook" type="url" class="form-control" id="Facebook"
                                            value="{{ current_user.facebook or '' }}"
                                            placeholder="https://facebook.com/seuusuario">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Instagram" class="col-md-4 col-lg-3 col-form-label">Instagram
                                        Profile</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="instagram" type="url" class="form-control" id="Instagram"
                                            value="{{ current_user.instagram or '' }}"
                                            placeholder="https://instagram.com/seuusuario">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="Linkedin" class="col-md-4 col-lg-3 col-form-label">LinkedIn
                                        Profile</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="linkedin" type="url" class="form-control" id="Linkedin"
                                            value="{{ current_user.linkedin or '' }}"
                                            placeholder="https://linkedin.com/in/seuusuario">
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                                    <a href="{{ url_for('main.profile') }}" class="btn btn-secondary">Cancelar</a>
                                </div>
                            </form><!-- End Profile Edit Form -->

                        </div>

                        <div class="tab-pane fade pt-3" id="profile-settings">

                            <!-- Settings Form -->
                            <form method="POST" action="{{ url_for('main.atualizar_configuracoes') }}">

                                <div class="row mb-3">
                                    <label class="col-md-4 col-lg-3 col-form-label">Notificações por Email</label>
                                    <div class="col-md-8 col-lg-9">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="changesMade"
                                                name="notificacao_alteracoes" {% if current_user.notificacao_alteracoes
                                                %}checked{% endif %}>
                                            <label class="form-check-label" for="changesMade">
                                                Alterações na sua conta
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="newProducts"
                                                name="notificacao_novos_produtos" {% if
                                                current_user.notificacao_novos_produtos %}checked{% endif %}>
                                            <label class="form-check-label" for="newProducts">
                                                Novos produtos e serviços
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="proOffers"
                                                name="notificacao_ofertas" {% if current_user.notificacao_ofertas
                                                %}checked{% endif %}>
                                            <label class="form-check-label" for="proOffers">
                                                Ofertas e promoções
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="securityNotify" checked
                                                disabled>
                                            <label class="form-check-label" for="securityNotify">
                                                Alertas de segurança
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label class="col-md-4 col-lg-3 col-form-label">Preferências do Sistema</label>
                                    <div class="col-md-8 col-lg-9">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="darkMode"
                                                name="modo_escuro" {% if current_user.modo_escuro %}checked{% endif %}>
                                            <label class="form-check-label" for="darkMode">
                                                Modo escuro
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoSave"
                                                name="salvamento_automatico" {% if current_user.salvamento_automatico
                                                %}checked{% endif %}>
                                            <label class="form-check-label" for="autoSave">
                                                Salvamento automático
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">Salvar Configurações</button>
                                </div>
                            </form><!-- End settings Form -->

                        </div>

                        <div class="tab-pane fade pt-3" id="profile-change-password">
                            <!-- Change Password Form -->
                            <form method="POST" action="{{ url_for('main.alterar_senha') }}">

                                <div class="row mb-3">
                                    <label for="currentPassword" class="col-md-4 col-lg-3 col-form-label">Senha
                                        Atual</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="currentPassword" type="password" class="form-control"
                                            id="currentPassword" required>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="newPassword" class="col-md-4 col-lg-3 col-form-label">Nova Senha</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="newPassword" type="password" class="form-control" id="newPassword"
                                            required minlength="6">
                                        <div class="password-strength mt-1">
                                            <small class="form-text text-muted">
                                                A senha deve ter pelo menos 6 caracteres
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <label for="renewPassword" class="col-md-4 col-lg-3 col-form-label">Confirmar Nova
                                        Senha</label>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="renewPassword" type="password" class="form-control"
                                            id="renewPassword" required minlength="6">
                                        <div class="password-match mt-1">
                                            <small class="form-text text-muted" id="passwordMatchText"></small>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary" id="submitPassword">Alterar
                                        Senha</button>
                                </div>
                            </form><!-- End Change Password Form -->

                        </div>

                    </div><!-- End Bordered Tabs -->

                </div>
            </div>

        </div>
    </div>
</section>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<script>

    function removerImagem() {
        document.getElementById('profile-preview').src = "{{ url_for('static', filename='img/foto-padrao-perfil') }}";
        document.getElementById('profileImage').value = '';
    }


    // Preview da imagem do perfil
    document.getElementById('profileImage').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            // Verificar tamanho (5MB máximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('O arquivo é muito grande. Por favor, selecione uma imagem menor que 5MB.');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('profile-preview').src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // Validação do formulário de senha
    const passwordForm = document.querySelector('form[action*="alterar_senha"]');
    if (passwordForm) {
        const newPassword = document.getElementById('newPassword');
        const renewPassword = document.getElementById('renewPassword');
        const passwordMatchText = document.getElementById('passwordMatchText');
        const submitButton = document.getElementById('submitPassword');

        function validatePassword() {
            const match = newPassword.value === renewPassword.value;
            const validLength = newPassword.value.length >= 6;

            if (renewPassword.value) {
                if (match && validLength) {
                    passwordMatchText.textContent = 'Senhas coincidem!';
                    passwordMatchText.className = 'form-text text-success';
                    submitButton.disabled = false;
                } else if (!match) {
                    passwordMatchText.textContent = 'As senhas não coincidem!';
                    passwordMatchText.className = 'form-text text-danger';
                    submitButton.disabled = true;
                } else {
                    passwordMatchText.textContent = 'A senha deve ter pelo menos 6 caracteres';
                    passwordMatchText.className = 'form-text text-warning';
                    submitButton.disabled = true;
                }
            } else {
                passwordMatchText.textContent = '';
                submitButton.disabled = !validLength;
            }
        }

        newPassword.addEventListener('input', validatePassword);
        renewPassword.addEventListener('input', validatePassword);

        passwordForm.addEventListener('submit', function (e) {
            if (newPassword.value !== renewPassword.value) {
                e.preventDefault();
                alert('As senhas não coincidem!');
                return false;
            }

            if (newPassword.value.length < 6) {
                e.preventDefault();
                alert('A senha deve ter pelo menos 6 caracteres!');
                return false;
            }
        });
    }

    // Fechar alertas automaticamente após 5 segundos
    document.addEventListener('DOMContentLoaded', function () {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function (alert) {
            setTimeout(function () {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        });
    });
</script>

<style>
    .profile-card img.profile-page-img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        object-position: center;
        border: 3px solid #fff;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }

    #profile-preview.profile-page-img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        object-position: center;
        border: 2px solid #dee2e6;
    }


    .label {
        font-weight: 600;
        color: #495057;
    }

    .nav-tabs-bordered .nav-link.active {
        border-bottom: 3px solid #0d6efd;
        font-weight: 600;
        color: #0d6efd;
    }

    .form-check-label {
        font-weight: normal;
    }

    .alert {
        margin-bottom: 1rem;
    }

    .social-links a.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .social-links a {
        transition: all 0.3s ease;
    }

    .social-links a:hover {
        transform: translateY(-2px);
    }

    .password-strength .progress {
        height: 5px;
        margin-top: 5px;
    }

    .form-text.text-success {
        font-weight: 500;
    }

    .form-text.text-danger {
        font-weight: 500;
    }
</style>
{% endblock %}